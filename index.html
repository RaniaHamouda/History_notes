<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ููุตุฉ ุนุงุดู ุงูุชุงุฑูุฎ | Ancient History Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      /* ุชุฎุตูุต ุฎุท ุนุฑุจู ููุงุณุจ */
      @import url("https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;900&display=swap");
      body {
        font-family: "Tajawal", sans-serif;
        background-color: #050505;
        opacity: 1;
        color: #eaeaea;
      }
      /* ุงูุฃููุงู ุงูุฐูุจูุฉ */
      .gold-color {
        color: #d4af37;
      }
      .gold-border {
        border-color: #d4af37;
      }
      .gold-bg {
        background-color: #d4af37;
      }

      /* ุงูุธูุงู ุงูุฐูุจูุฉ ุงููุทููุจุฉ */
      .gold-shadow {
        box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
      }
      .lesson-card,
      .char-card,
      .quiz-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
        border-left: 4px solid #d4af3750;
      }
      .lesson-card:hover,
      .char-card:hover,
      .quiz-card:hover {
        transform: translateY(-7px);
        box-shadow: 0 15px 30px rgba(212, 175, 55, 0.5);
      }

      /* **** ุงูููุฏ ุงูููุนุฏู ููุฎูููุฉ (ุฃุบูู ูุฃูุฏุฃ) **** */
      .hero-bg {
        background-color: #050505;
        opacity: 1;

        background-image:
            /* ุทุจูุฉ ุชุธููู ุฏุงููุฉ ููู ุงูุตูุฑุฉ ูุชุบููููุง */ linear-gradient(
            rgba(0, 0, 0, 0.6),
            rgba(0, 0, 0, 0.6)
          ),
          /* ุงูุชุฏุฑุฌ ุงูุฏุงุฆุฑู ุงูุฃุตูู ููุญุฑูุฉ ุงููุงุนูุฉ */
            radial-gradient(
              circle at 10% 20%,
              rgba(16, 16, 16, 0.3) 0%,
              rgba(5, 5, 5, 0.8) 100%
            ),
          /* ุงูุตูุฑุฉ ุงูุฃุตููุฉ */ url(/images/bg.png);

        background-size: cover;
        background-attachment: fixed;
        /* ุญุฑูุฉ ุฃูุนู ูุฃูุฏุฃ (20 ุซุงููุฉ ุจุฏูุงู ูู 10) */
        animation: subtle-pulse 20s infinite alternate ease-in-out;
      }
      @keyframes subtle-pulse {
        from {
          background-position: 0% 0%;
        }
        to {
          background-position: 100% 100%;
        }
      }

      .delete-btn {
        background-color: #5c0000;
        transition: background-color 0.2s, box-shadow 0.2s;
      }
      .delete-btn:hover {
        background-color: #7a0000;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
      }

      /* ุชุตููู ุญูู ูููุฉ ุงููุฑูุฑ ูุน ุงูุฃููููุฉ */
      .password-container {
        position: relative;
      }
      .toggle-password {
        position: absolute;
        left: 10px; /* Adjust for RTL */
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #d4af37;
        padding: 5px;
        z-index: 10;
      }
      /* ุชุตููู ุฒุฑ ุชุนููู ููุฏูุฑ */
      .admin-set-btn {
        background-color: #384210;
        transition: background-color 0.2s, box-shadow 0.2s;
      }
      .admin-set-btn:hover {
        background-color: #5b7029;
      }

      /* ูุชูุจูุฑ ุฃููููุงุช ุงูุชููู ููููุงู */
      .nav-icon {
        font-size: 1.25rem; /* text-xl */
        margin-left: 0.25rem;
      }

      /* ุชูุณูู ุฒุฑ ุงูุงูุถูุงู ููุฌูุณุฉ ุงููุจุงุดุฑุฉ */
      .live-btn {
        background-color: #008000; /* ุฃุฎุถุฑ ุฒูู ุฃู ููุช */
        transition: background-color 0.3s, transform 0.3s;
      }
      .live-btn:hover {
        background-color: #00a000;
        transform: scale(1.05);
      }

      /* ุชุตููู ูููุฐุฌ ุงูุฏุฎูู ุงููููุตู */
      #auth-card {
        background-color: #1a1a1a;
        border: 2px solid #d4af37;
        animation: fadeIn 0.5s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
    </style>
  </head>
  <body class="hero-bg">
    <!-- Modal ูุชุณุฌูู ุงูุฏุฎูู / ุงูุชุณุฌูู -->
    <div id="auth-modal-container">
      <div
        id="auth-modal"
        class="fixed inset-0 bg-black bg-opacity-75 z-[100] hidden flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300"
      >
        <div id="auth-card" class="p-8 rounded-xl w-full max-w-md gold-shadow">
          <div
            class="flex justify-between items-center mb-6 border-b gold-border pb-2"
          >
            <h3 class="text-2xl gold-color font-bold" id="auth-title">
              ุชุณุฌูู ุงูุฏุฎูู
            </h3>
            <button
              onclick="closeAuthModal()"
              class="text-white hover:gold-color text-2xl"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>

          <form id="login-form" class="space-y-4">
            <div>
              <input
                type="email"
                id="login-email"
                required
                placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู"
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
              />
            </div>
            <div class="password-container">
              <input
                type="password"
                id="login-password"
                required
                placeholder="ูููุฉ ุงููุฑูุฑ"
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
              />
              <i
                class="fas fa-eye toggle-password"
                data-target="login-password"
                onclick="togglePasswordVisibility(this)"
              ></i>
            </div>

            <button
              type="submit"
              class="w-full py-3 gold-bg text-gray-900 font-bold rounded-lg gold-shadow hover:bg-yellow-500 transition"
            >
              ุชุณุฌูู ุงูุฏุฎูู
            </button>
            <p class="text-center text-sm text-gray-400 mt-4">
              ููุณ ูุฏูู ุญุณุงุจุ
              <a
                href="#"
                id="switch-to-signup"
                class="gold-color hover:text-yellow-500"
                >ุณุฌู ุงูุขู</a
              >
            </p>
            <div
              id="auth-message-box"
              class="mt-4 p-3 rounded-lg hidden text-sm text-center font-medium gold-shadow bg-gray-700 text-yellow-300"
            ></div>
          </form>

          <form id="signup-form" class="space-y-4 hidden">
            <div>
              <input
                type="text"
                id="signup-name"
                required
                placeholder="ุงุณู ุงููุณุชุฎุฏู (Admin ูููุตูู ููุฏูุฑ)"
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
              />
            </div>
            <div>
              <input
                type="email"
                id="signup-email"
                required
                placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู"
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
              />
            </div>
            <div class="password-container">
              <input
                type="password"
                id="signup-password"
                required
                placeholder="ูููุฉ ุงููุฑูุฑ (6 ุฃุญุฑู ุนูู ุงูุฃูู)"
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
              />
              <i
                class="fas fa-eye toggle-password"
                data-target="signup-password"
                onclick="togglePasswordVisibility(this)"
              ></i>
            </div>

            <button
              type="submit"
              id="signup-submit-btn"
              class="w-full py-3 gold-bg text-gray-900 font-bold rounded-lg gold-shadow hover:bg-yellow-500 transition"
            >
              ุชุณุฌูู ุญุณุงุจ ุฌุฏูุฏ
            </button>
            <p class="text-center text-sm text-gray-400 mt-4">
              ูุฏูู ุญุณุงุจ ุจุงููุนูุ
              <a
                href="#"
                id="switch-to-login"
                class="gold-color hover:text-yellow-500"
                >ุชุณุฌูู ุงูุฏุฎูู</a
              >
            </p>
          </form>
        </div>
      </div>
      
      <!-- Modal ุงุฎุชูุงุฑ ุงููุฑุญูุฉ ุงูุชุนููููุฉ (ุงูุฌุฏูุฏ) -->
      <div
        id="grade-selector-modal"
        class="fixed inset-0 bg-black bg-opacity-75 z-[110] hidden flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300"
      >
        <div id="grade-card" class="p-8 rounded-xl w-full max-w-lg gold-shadow bg-gray-900 border border-yellow-800">
          <h3 class="text-2xl gold-color font-bold mb-4 border-b gold-border pb-2">
            ุญุฏุฏ ุงููุฑุญูุฉ ุงูุชุนููููุฉ
          </h3>
          <p class="text-gray-400 mb-6">
            ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ ูุนุฑุถ ุงููุญุชูู ุงูููุงุณุจ ูู. ูููู ุชุบููุฑ ูุฐุง ุงูุฎูุงุฑ ูุงุญููุง ูู ุฅุนุฏุงุฏุงุช ุญุณุงุจู.
          </p>
          <form id="grade-select-form" class="space-y-4">
            <div>
              <label for="grade-level-select" class="block text-sm font-medium gold-color mb-1">
                ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ
              </label>
              <select 
                id="grade-level-select" 
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white" 
                required
              >
                <option value="">-- ูุฑุฌู ุงูุงุฎุชูุงุฑ --</option>
                <!-- ุฎูุงุฑุงุช ุงูุตููู ุณุชูููุฃ ูู JavaScript -->
              </select>
            </div>
            <button
              type="submit"
              class="w-full py-3 gold-bg text-gray-900 font-bold rounded-lg gold-shadow hover:bg-yellow-500 transition"
            >
              ุชุฃููุฏ ุงูุงุฎุชูุงุฑ ูุงูุงูุชูุงู <i class="fas fa-chevron-left mr-2"></i>
            </button>
          </form>
          <div
            id="grade-status-message"
            class="mt-4 p-3 rounded-lg hidden text-sm text-center font-medium gold-shadow bg-gray-700 text-yellow-300"
          ></div>
        </div>
      </div>
      
      <!-- Modal ุงูุจุญุซ ุงูุนุงู (ุงูุฌุฏูุฏ) -->
      <div
        id="search-modal"
        class="fixed inset-0 bg-black bg-opacity-75 z-[110] hidden flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300"
      >
        <div id="search-card" class="p-8 rounded-xl w-full max-w-2xl gold-shadow bg-gray-900 border border-yellow-800">
          <div class="flex justify-between items-center mb-6 border-b gold-border pb-2">
            <h3 class="text-2xl gold-color font-bold">
              ุงูุจุญุซ ูู ุงููุญุชูู
            </h3>
            <button
              onclick="closeSearchModal()"
              class="text-white hover:gold-color text-2xl"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <form id="global-search-form" class="space-y-4">
            <input
              type="search"
              id="global-search-input"
              required
              placeholder="ุงุจุญุซ ุนู ุฏุฑุณุ ุดุฎุตูุฉุ ุฃู ุงุฎุชุจุงุฑ..."
              class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500 text-lg"
            />
            <button
              type="submit"
              class="w-full py-3 gold-bg text-gray-900 font-bold rounded-lg gold-shadow hover:bg-yellow-500 transition"
            >
              ุงุจุญุซ <i class="fas fa-search mr-2"></i>
            </button>
          </form>

          <div class="mt-6 border-t pt-4 border-gray-700/50">
              <h4 class="text-xl gold-color mb-3" id="search-results-title">ูุชุงุฆุฌ ุงูุจุญุซ:</h4>
              <div id="search-results-list" class="space-y-4 max-h-96 overflow-y-auto">
                  <p class="text-gray-500" id="search-status">ุงุจุฏุฃ ุจูุชุงุจุฉ ูููุฉ ููุจุญุซ...</p>
              </div>
          </div>
        </div>
      </div>


      <header
        class="sticky top-0 z-50 p-4 bg-gray-900/90 backdrop-blur-sm shadow-xl border-b border-yellow-800/50"
      >
        <div
          class="max-w-7xl mx-auto flex justify-between items-center flex-wrap"
        >
          <div class="flex items-center space-x-3 space-x-reverse mb-2 md:mb-0">
            <i class="fas fa-pyramid w-10 h-10 gold-color text-4xl"></i>
            <img src="images/logo.png" alt="imge" class="w-[140px] h-[120px]" />
            <h1
              class="text-xl md:text-2xl gold-color font-extrabold tracking-wider ml-5"
            >
              ุนุงุดู ุงูุชุงุฑูุฎ
            </h1>
          </div>

          <button
            id="mobile-menu-button"
            class="md:hidden gold-color text-2xl p-2 rounded-full hover:bg-gray-800 transition focus:outline-none"
          >
            <i class="fas fa-bars"></i>
          </button>

          <nav
            id="main-nav-links"
            class="hidden md:flex flex-col md:flex-row items-center space-x-6 space-x-reverse font-medium w-full md:w-auto mt-4 md:mt-0"
          >
            <a
              href="#"
              id="nav-live-session"
              class="text-white hover:gold-color transition block md:inline-block w-full md:w-auto p-2 md:p-0 hidden"
            >
              <i class="fas fa-video nav-icon gold-color animate-pulse"></i>
              ูุจุงุดุฑ
            </a>

            <a
              href="#lessons-section"
              id="nav-lessons"
              class="text-white hover:gold-color transition block md:inline-block w-full md:w-auto p-2 md:p-0"
              ><i class="fas fa-book-open nav-icon gold-color"></i> ุงูุฏุฑูุณ</a
            >
            <a
              href="#characters-section"
              id="nav-characters"
              class="text-white hover:gold-color transition block md:inline-block w-full md:w-auto p-2 md:p-0"
              ><i class="fas fa-user-friends nav-icon gold-color"></i>
              ุงูุดุฎุตูุงุช</a
            >
            <a
              href="#quizzes-section"
              id="nav-quizzes"
              class="text-white hover:gold-color transition block md:inline-block w-full md:w-auto p-2 md:p-0"
              ><i class="fas fa-clipboard-list nav-icon gold-color"></i>
              ุงูุงุฎุชุจุงุฑุงุช</a
            >
            
            <!-- ุฃููููุฉ ุงูุจุญุซ ุงูุฌุฏูุฏุฉ -->
            <button
              id="search-button"
              onclick="openSearchModal()"
              class="gold-color text-xl p-2 rounded-full hover:bg-gray-800 transition"
            >
                <i class="fas fa-search" id="search-icon"></i>
            </button>


            <button
              id="admin-toggle-btn"
              class="py-1 px-3 rounded-full text-xs font-bold transition duration-300 gold-shadow hidden mt-2 md:mt-0"
              style="background-color: #1a1a1a; border: 1px solid #d4af37"
            >
              (Admin Mode)
            </button>

            <button
              id="auth-button"
              class="gold-color text-xl p-2 rounded-full hover:bg-gray-800 transition mt-2 md:mt-0"
            >
              <i class="fas fa-sign-in-alt" id="auth-icon"></i>
            </button>
          </nav>
        </div>
      </header>

      <main>
        <section
          id="hero"
          class="hero-bg py-24 md:py-32 text-center border-b border-yellow-700/50 gold-shadow"
        >
          <div class="max-w-4xl mx-auto px-6">
            <p
              class="text-4xl md:text-6xl font-black mb-6 leading-tight gold-color"
            >
              ุชุนูู ุงูุชุงุฑูุฎ ... ุจุทุฑููุฉ ุชุญูู ุงููุงุถู
            </p>
            <p
              id="access-status"
              class="text-lg text-gray-400 font-medium mb-10 hidden"
            >
              <i class="fas fa-lock ml-2"></i> ููุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ุฃู ุงูุชุธุงุฑ
              ููุงููุฉ ุงููุฏูุฑ ูููุตูู ุฅูู ุงููุญุชูู.
            </p>
            <a
              href="#lessons-section"
              class="inline-block py-4 px-10 rounded-full gold-bg text-gray-900 font-bold text-lg gold-shadow hover:bg-yellow-500 transition transform hover:scale-105 duration-300 ease-in-out"
            >
              ุงุจุฏุฃ ุงูุชุนูู ุงูุขู <i class="fas fa-long-arrow-alt-left mr-2"></i>
            </a>
          </div>
        </section>
        
        <!-- ****** ูุณู ุฅุฏุงุฑุฉ ุงูุฌูุณุฉ ุงููุจุงุดุฑุฉ ****** -->
        <section
          id="admin-live-session-section"
          class="hidden max-w-7xl mx-auto my-12 p-6 md:p-12 bg-gray-900/80 rounded-xl border gold-border gold-shadow"
        >
          <h2
            class="text-2xl font-bold mb-6 text-white border-b pb-2 gold-border flex items-center"
          >
            <i class="fas fa-broadcast-tower gold-color ml-2"></i> ุฅุฏุงุฑุฉ ุฑุงุจุท
            ุงูุจุซ ุงููุจุงุดุฑ
          </h2>
          <form id="live-session-form" class="space-y-4">
            <div>
              <label
                for="live-session-url"
                class="block text-sm font-medium gold-color mb-1"
                >ุฑุงุจุท ุงูุฌูุณุฉ ุงููุจุงุดุฑุฉ (Meet ุฃู Zoom)</label
              >
              <input
                type="url"
                id="live-session-url"
                required
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
                placeholder="https://meet.google.com/abc-xyz-123"
              />
            </div>
            <div>
              <label
                for="live-session-desc"
                class="block text-sm font-medium gold-color mb-1"
                >ูุตู ุงูุฌูุณุฉ</label
              >
              <input
                type="text"
                id="live-session-desc"
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
                placeholder="ูุซุงู: ูุฑุงุฌุนุฉ ุงููุญุฏุฉ ุงูุซุงููุฉุ ุงูููู: ุงูุฎููุณ 7 ูุณุงุกู"
              />
            </div>
            <button
              type="submit"
              id="update-live-session-btn"
              class="w-full py-3 px-4 rounded-lg bg-green-700 text-white font-bold hover:bg-green-600 transition gold-shadow"
            >
              ุญูุธ / ุชุญุฏูุซ ุฑุงุจุท ุงูุฌูุณุฉ ุงููุจุงุดุฑุฉ
            </button>
          </form>
          <div
            id="live-session-status-message"
            class="mt-4 p-3 rounded-lg hidden text-sm text-center font-medium gold-shadow"
          ></div>
        </section>

        <section
          id="admin-users-approval"
          class="hidden max-w-7xl mx-auto my-12 p-6 md:p-12 bg-gray-900/80 rounded-xl border gold-border gold-shadow"
        >
          <h2
            class="text-2xl font-bold mb-6 text-white border-b pb-2 gold-border flex items-center"
          >
            <i class="fas fa-users-cog gold-color ml-2"></i> ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
            ูุงูุฃุฏูุงุฑ
          </h2>

          <div class="mb-4">
            <input
              type="text"
              id="user-search-input"
              placeholder="ุงุจุญุซ ุจุงูุงุณู ุฃู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู"
              class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
            />
          </div>

          <div id="pending-users-list" class="space-y-4">
            <p class="text-gray-500" id="users-loading-status">
              ุฌุงุฑู ุชุญููู ูุงุฆูุฉ ุงููุณุชุฎุฏููู...
            </p>
          </div>
        </section>
        
        <!-- ****** ูุณู ุฅุฏุงุฑุฉ ุงููุฑุงุญู ุงูุชุนููููุฉ (ุงูุฌุฏูุฏ) ****** -->
        <section
          id="admin-grades-section"
          class="hidden max-w-7xl mx-auto my-12 p-6 md:p-12 bg-gray-900/80 rounded-xl border gold-border gold-shadow"
        >
          <h2
            class="text-2xl font-bold mb-6 text-white border-b pb-2 gold-border flex items-center"
          >
            <i class="fas fa-graduation-cap gold-color ml-2"></i> ุฅุฏุงุฑุฉ ุงููุฑุงุญู ุงูุชุนููููุฉ (ุงูุตููู)
          </h2>
          <form id="add-grade-form" class="space-y-4 mb-6 border-b pb-4 border-gray-700/50">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-2">
                    <label for="new-grade-name" class="block text-sm font-medium gold-color mb-1">
                        ุงุณู ุงููุฑุญูุฉ (ุงูุตู)
                    </label>
                    <input
                        type="text"
                        id="new-grade-name"
                        required
                        placeholder="ูุซุงู: ุงูุตู ุงูุฃูู ุงูุซุงููู"
                        class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
                    />
                </div>
                <div>
                    <button
                        type="submit"
                        id="add-grade-btn"
                        class="w-full py-3 px-4 rounded-lg bg-blue-700 text-white font-bold hover:bg-blue-600 transition gold-shadow mt-5 md:mt-0"
                    >
                        ุฅุถุงูุฉ ูุฑุญูุฉ ุฌุฏูุฏุฉ
                    </button>
                </div>
            </div>
            <div id="grade-add-status-message" class="mt-2 text-sm text-center font-medium text-yellow-300 hidden"></div>
          </form>
          
          <div id="grades-list-admin" class="space-y-3">
             <p class="text-gray-500">ุฌุงุฑู ุชุญููู ุงููุฑุงุญู ุงููุถุงูุฉ...</p>
          </div>
        </section>
        <!-- ****** ููุงูุฉ ูุณู ุฅุฏุงุฑุฉ ุงููุฑุงุญู ุงูุชุนููููุฉ ****** -->
        
        <!-- ****** ูุณู ุฑุตุฏ ุงูุฏุฑุฌุงุช ****** -->
        <section
          id="admin-score-entry-section"
          class="hidden max-w-7xl mx-auto my-12 p-6 md:p-12 bg-gray-900/80 rounded-xl border gold-border gold-shadow"
        >
          <h2
            class="text-2xl font-bold mb-6 text-white border-b pb-2 gold-border flex items-center"
          >
            <i class="fas fa-calculator gold-color ml-2"></i> ุฑุตุฏ ุฏุฑุฌุงุช ุงูุงุฎุชุจุงุฑุงุช
          </h2>
          <form id="score-entry-form" class="space-y-4">
            <div>
              <label for="score-student-uid" class="block text-sm font-medium gold-color mb-1">
                ุงุณู/ุจุฑูุฏ ุงูุทุงูุจ (ููุจุญุซ)
              </label>
              <input
                type="text"
                id="score-student-search"
                placeholder="ุงุจุญุซ ุนู ุงุณู ุงูุทุงูุจ ุฃู ุจุฑูุฏู ุงูุฅููุชุฑููู"
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
              />
              <select id="score-student-select" class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white mt-2" required>
                <option value="">-- ุญุฏุฏ ุงูุทุงูุจ --</option>
              </select>
            </div>

            <div>
              <label for="score-quiz-select" class="block text-sm font-medium gold-color mb-1">
                ุงุณู ุงูุงุฎุชุจุงุฑ
              </label>
              <select id="score-quiz-select" class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white" required>
                <option value="">-- ุญุฏุฏ ุงูุงุฎุชุจุงุฑ --</option>
              </select>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="score-value" class="block text-sm font-medium gold-color mb-1">
                        ุงูุฏุฑุฌุฉ ุงููุญููุฉ
                    </label>
                    <input
                        type="number"
                        id="score-value"
                        required
                        min="0"
                        placeholder="ุฏุฑุฌุฉ ุงูุทุงูุจ"
                        class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium gold-color mb-1">
                        ุงูุฏุฑุฌุฉ ุงููููุฉ (ุชููุงุฆู)
                    </label>
                    <input
                        type="number"
                        id="score-max-display"
                        readonly
                        class="w-full p-3 rounded-lg bg-gray-700 border gold-border text-white placeholder-gray-500"
                    />
                </div>
            </div>

            <div>
              <label for="score-notes" class="block text-sm font-medium gold-color mb-1">
                ููุงุญุธุงุช ุงููุฏูุฑ (ุงุฎุชูุงุฑู)
              </label>
              <textarea
                id="score-notes"
                rows="2"
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
                placeholder="ููุงุญุธุงุช ุญูู ุฃุฏุงุก ุงูุทุงูุจ"
              ></textarea>
            </div>

            <button
              type="submit"
              id="submit-score-btn"
              class="w-full py-3 px-4 rounded-lg gold-bg text-gray-900 font-bold hover:bg-yellow-500 transition gold-shadow disabled:opacity-50"
            >
              ุชุณุฌูู ุงูุฏุฑุฌุฉ ููุทุงูุจ
            </button>
          </form>
          <div
            id="score-status-message"
            class="mt-4 p-3 rounded-lg hidden text-sm text-center font-medium gold-shadow"
          ></div>
        </section>
        <!-- ****** ููุงูุฉ ูุณู ุฑุตุฏ ุงูุฏุฑุฌุงุช ****** -->

        <section
          id="add-lesson-section"
          class="hidden max-w-7xl mx-auto mb-12 p-6 md:p-12 bg-gray-900/80 rounded-xl border gold-border gold-shadow"
        >
          <h2
            class="text-2xl font-bold mb-6 text-white border-b pb-2 gold-border flex items-center"
          >
            <i class="fas fa-cogs gold-color ml-2"></i> ููุญุฉ ุชุญูู ุงููุฏูุฑ: ุฅุถุงูุฉ
            ุฏุฑุณ ุฌุฏูุฏ
          </h2>
          <form id="add-lesson-form" class="space-y-4">
            <div>
              <label
                for="lesson-grade-select"
                class="block text-sm font-medium gold-color mb-1"
                >ุงููุฑุญูุฉ ุงูุชุนููููุฉ</label
              >
              <select 
                id="lesson-grade-select" 
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white" 
                required
              >
                <option value="">-- ุญุฏุฏ ุงููุฑุญูุฉ --</option>
              </select>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label
                  for="lesson-title"
                  class="block text-sm font-medium gold-color mb-1"
                  >ุนููุงู ุงูุฏุฑุณ</label
                >
                <input
                  type="text"
                  id="lesson-title"
                  required
                  class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
                  placeholder="ูุซุงู: ุนุตุฑ ุงูุฃุณุฑุงุช"
                />
              </div>
              <div>
                <label
                  for="lesson-pdf-url"
                  class="block text-sm font-medium gold-color mb-1"
                  >ุฑุงุจุท ููู PDF ุงููุจุงุดุฑ (ุงุฎุชูุงุฑู)</label
                >
                <input
                  type="url"
                  id="lesson-pdf-url"
                  class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
                  placeholder="https://example.com/document.pdf"
                />
              </div>
            </div>
            <div>
              <label
                for="lesson-summary"
                class="block text-sm font-medium gold-color mb-1"
                >ููุฎุต ูุตูุฑ</label
              >
              <textarea
                id="lesson-summary"
                rows="3"
                required
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
                placeholder="ูุตู ููุฌุฒ"
              ></textarea>
            </div>
            <div>
              <label
                for="lesson-video-url"
                class="block text-sm font-medium gold-color mb-1"
                >ุฑุงุจุท ููู ุงูููุฏูู ุงููุจุงุดุฑ (ุงุฎุชูุงุฑู)</label
              >
              <input
                type="url"
                id="lesson-video-url"
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
                placeholder="https://example.com/video.mp4"
              />
            </div>
            <button
              type="submit"
              id="add-lesson-btn"
              class="w-full py-3 px-4 rounded-lg gold-bg text-gray-900 font-bold hover:bg-yellow-500 transition gold-shadow disabled:opacity-50"
            >
              ูุดุฑ ุงูุฏุฑุณ ุจุงูุฑูุงุจุท
            </button>
          </form>
          <div
            id="lesson-status-message"
            class="mt-4 p-3 rounded-lg hidden text-sm text-center font-medium gold-shadow"
          ></div>
        </section>

        <section
          id="add-character-section"
          class="hidden max-w-7xl mx-auto mb-12 p-6 md:p-12 bg-gray-900/80 rounded-xl border gold-border gold-shadow"
        >
          <h2
            class="text-2xl font-bold mb-6 text-white border-b pb-2 gold-border flex items-center"
          >
            <i class="fas fa-mask gold-color ml-2"></i> ููุญุฉ ุชุญูู ุงููุฏูุฑ: ุฅุถุงูุฉ
            ุดุฎุตูุฉ ุชุงุฑูุฎูุฉ ุฌุฏูุฏุฉ
          </h2>
          <form id="add-character-form" class="space-y-4">
            <div>
              <label
                for="char-grade-select"
                class="block text-sm font-medium gold-color mb-1"
                >ุงููุฑุญูุฉ ุงูุชุนููููุฉ</label
              >
              <select 
                id="char-grade-select" 
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white" 
                required
              >
                <option value="">-- ุญุฏุฏ ุงููุฑุญูุฉ --</option>
              </select>
            </div>

            <div>
              <label
                for="char-name"
                class="block text-sm font-medium gold-color mb-1"
                >ุงุณู ุงูุดุฎุตูุฉ</label
              >
              <input
                type="text"
                id="char-name"
                required
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
                placeholder="ูุซุงู: ุงูููู ุฃุญูุณ ุงูุฃูู"
              />
            </div>
            <div>
              <label
                for="char-era"
                class="block text-sm font-medium gold-color mb-1"
                >ุงูุนุตุฑ/ุงูุญูุจุฉ</label
              >
              <input
                type="text"
                id="char-era"
                required
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
                placeholder="ูุซุงู: ุงูุฏููุฉ ุงูุญุฏูุซุฉุ ุนุตุฑ ุงูุฃุณุฑุฉ ุงูุซุงููุฉ ุนุดุฑุฉ"
              />
            </div>
            <div>
              <label
                for="char-bio"
                class="block text-sm font-medium gold-color mb-1"
                >ูุจุฐุฉ ูุฎุชุตุฑุฉ ุนู ุงูุฅูุฌุงุฒุงุช</label
              >
              <textarea
                id="char-bio"
                rows="4"
                required
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
                placeholder="ุฃูู ุฅูุฌุงุฒุงุชู ูููุงูุชู ุงูุชุงุฑูุฎูุฉ"
              ></textarea>
            </div>
            <button
              type="submit"
              id="add-character-btn"
              class="w-full py-3 px-4 rounded-lg gold-bg text-gray-900 font-bold hover:bg-yellow-500 transition gold-shadow disabled:opacity-50"
            >
              ูุดุฑ ุงูุดุฎุตูุฉ
            </button>
          </form>
          <div
            id="char-status-message"
            class="mt-4 p-3 rounded-lg hidden text-sm text-center font-medium gold-shadow"
          ></div>
        </section>

        <section
          id="add-quiz-section"
          class="hidden max-w-7xl mx-auto mb-12 p-6 md:p-12 bg-gray-900/80 rounded-xl border gold-border gold-shadow"
        >
          <h2
            class="text-2xl font-bold mb-6 text-white border-b pb-2 gold-border flex items-center"
          >
            <i class="fas fa-pencil-alt gold-color ml-2"></i> ููุญุฉ ุชุญูู ุงููุฏูุฑ:
            ุฅุถุงูุฉ ุงุฎุชุจุงุฑ ุฌุฏูุฏ
          </h2>
          <form id="add-quiz-form" class="space-y-4">
            <div>
              <label
                for="quiz-grade-select"
                class="block text-sm font-medium gold-color mb-1"
                >ุงููุฑุญูุฉ ุงูุชุนููููุฉ</label
              >
              <select 
                id="quiz-grade-select" 
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white" 
                required
              >
                <option value="">-- ุญุฏุฏ ุงููุฑุญูุฉ --</option>
              </select>
            </div>

            <div>
              <label
                for="quiz-title"
                class="block text-sm font-medium gold-color mb-1"
                >ุนููุงู ุงูุงุฎุชุจุงุฑ</label
              >
              <input
                type="text"
                id="quiz-title"
                required
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
                placeholder="ูุซุงู: ุงุฎุชุจุงุฑ ุงููุญุฏุฉ ุงูุฃููู: ุงูุนุตุฑ ุงููุฑุนููู"
              />
            </div>
            <div>
              <label
                for="quiz-google-form-url"
                class="block text-sm font-medium gold-color mb-1"
                >ุฑุงุจุท ูููุฐุฌ Google Form (ุฅูุฒุงูู)</label
              >
              <input
                type="url"
                id="quiz-google-form-url"
                required
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
                placeholder="https://docs.google.com/forms/d/e/1FAIpQL.../viewform"
              />
            </div>
            <div>
              <label
                for="quiz-max-score"
                class="block text-sm font-medium gold-color mb-1"
                >ุงูุฏุฑุฌุฉ ุงููููุฉ ููุงุฎุชุจุงุฑ</label
              >
              <input
                type="number"
                id="quiz-max-score"
                required
                min="1"
                value="10"
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
              />
            </div>
            <div>
              <label
                for="quiz-description"
                class="block text-sm font-medium gold-color mb-1"
                >ูุตู ุงูุงุฎุชุจุงุฑ (ุชุนูููุงุช)</label
              >
              <textarea
                id="quiz-description"
                rows="2"
                class="w-full p-3 rounded-lg bg-gray-800 border gold-border text-white placeholder-gray-500"
                placeholder="ูุฐุง ุงูุงุฎุชุจุงุฑ ูููุณ ูุฏู ูููู ูููุงููู..."
              ></textarea>
            </div>
            <button
              type="submit"
              id="add-quiz-btn"
              class="w-full py-3 px-4 rounded-lg gold-bg text-gray-900 font-bold hover:bg-yellow-500 transition gold-shadow disabled:opacity-50"
            >
              ูุดุฑ ุงูุงุฎุชุจุงุฑ
            </button>
          </form>
          <div
            id="quiz-status-message"
            class="mt-4 p-3 rounded-lg hidden text-sm text-center font-medium gold-shadow"
          ></div>
        </section>

        <!-- ุงูุฃูุณุงู ุงูุฑุฆูุณูุฉ ูููุญุชูู (ูุฎููุฉ ุงูุขู) -->
        <section id="lessons-section" class="max-w-7xl mx-auto p-6 md:p-12 hidden">
          <h2
            class="text-2xl font-bold mb-8 text-white border-b pb-2 gold-border"
          >
            ููุชุจุฉ ุงูุฏุฑูุณ ุงููุชุงุญุฉ
          </h2>
          <p id="lessons-loading-status" class="text-center text-gray-500 my-8">
            ... ูุชู ุชุญููู ุงูุจูุงูุงุช ูู ุณุฌูุงุช ุงูุชุงุฑูุฎ
          </p>
          <div
            id="lessons-list"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
          ></div>
        </section>

        <section id="characters-section" class="max-w-7xl mx-auto p-6 md:p-12 hidden">
          <h2
            class="text-2xl font-bold mb-8 text-white border-b pb-2 gold-border"
          >
            ุดุฎุตูุงุช ุชุงุฑูุฎูุฉ ุจุงุฑุฒุฉ
          </h2>
          <p
            id="characters-loading-status"
            class="text-center text-gray-500 my-8"
          >
            ... ูุชู ุชุญููู ุงูุดุฎุตูุงุช ุงูุชุงุฑูุฎูุฉ
          </p>
          <div
            id="characters-list"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"
          ></div>
        </section>

        <section id="quizzes-section" class="max-w-7xl mx-auto p-6 md:p-12 hidden">
          <h2
            id="quizzes-title"
            class="text-2xl font-bold mb-8 text-white border-b pb-2 gold-border"
          >
            ุงูุงุฎุชุจุงุฑุงุช ูุงููุชุงุฆุฌ
          </h2>
          <p id="quizzes-loading-status" class="text-center text-gray-500 my-8">
            ... ูุชู ุชุญููู ุงูุงุฎุชุจุงุฑุงุช ูุงููุชุงุฆุฌ
          </p>
          <div
            id="quizzes-list"
            class="grid grid-cols-1 md:grid-cols-2 gap-6"
          ></div>
          <div id="quiz-admin-all-results" class="hidden mt-8"></div>
        </section>
        
        <!-- ****** ุดุงุดุฉ ูุชุงุฆุฌ ุงูุจุญุซ (ููุณ ููููุฉ ุงูุฃูุณุงู ุงูุฑุฆูุณูุฉ) ****** -->
        <section id="search-results-section" class="max-w-7xl mx-auto p-6 md:p-12 hidden">
            <h2 class="text-2xl font-bold mb-8 text-white border-b pb-2 gold-border flex items-center">
                <i class="fas fa-search gold-color ml-2"></i> ูุชุงุฆุฌ ุงูุจุญุซ ุนู: <span id="search-query-display" class="mr-2 text-yellow-400">...</span>
            </h2>
            <p id="search-status-main" class="text-gray-500 text-center my-8">
                ุฌุงุฑู ุงูุจุญุซ...
            </p>
            <div id="search-results-output" class="space-y-8">
                <!-- ุงููุชุงุฆุฌ ุณุชูุนุฑุถ ููุง -->
            </div>
        </section>

      </main>
    </div>

    <script type="module">
      // ** ๐ ุฅุนุฏุงุฏุงุช Firebase ุงูุฎุงุตุฉ ุจูุดุฑูุนู (ููุทุจูุฉ) ๐ **
      const firebaseConfig = {
        apiKey: "AIzaSyAt9RuqyoOUkbDW8465aEXA8qzC413XSDw",
        authDomain: "history-notes-a88e0.firebaseapp.com",
        projectId: "history-notes-a88e0",
        storageBucket: "history-notes-a88e0.firebasestorage.app",
        messagingSenderId: "946649985119",
        appId: "1:946649985119:web:03630ee34ca1d31f752bea",
        measurementId: "G-C528QQV2HS",
      };

      // ุงุณุชูุฑุงุฏ ูุธุงุฆู Firebase ุงูุฃุณุงุณูุฉ
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        updateProfile, // ๐ ููุถุงูุฉ ููุงุณุชุฎุฏุงู ูู ุงูุชุณุฌูู
      } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        onSnapshot,
        updateDoc,
        addDoc,
        deleteDoc,
        query,
        where,
        limit,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js";

      // ุชููุฆุฉ Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const analytics = getAnalytics(app);
      const appId = firebaseConfig.appId;

      // **********************************************
      // ************ ุงููุชุบูุฑุงุช ุงูุนุงูุฉ ************
      // **********************************************
      const authModal = document.getElementById("auth-modal");
      const authTitle = document.getElementById("auth-title");
      const loginForm = document.getElementById("login-form");
      const signupForm = document.getElementById("signup-form");
      const signupSubmitBtn = document.getElementById("signup-submit-btn");
      const authButton = document.getElementById("auth-button");
      const authMessageBox = document.getElementById("auth-message-box");
      const authIcon = document.getElementById("auth-icon");
      const heroSection = document.getElementById("hero");
      const accessStatus = document.getElementById("access-status");
      const adminToggleBtn = document.getElementById("admin-toggle-btn");

      const gradeSelectorModal = document.getElementById("grade-selector-modal");
      const gradeSelectForm = document.getElementById("grade-select-form");
      const gradeLevelSelect = document.getElementById("grade-level-select");
      const gradeStatusMessage = document.getElementById("grade-status-message");

      const searchModal = document.getElementById("search-modal");
      const searchInput = document.getElementById("global-search-input");
      const searchResultsList = document.getElementById("search-results-list");
      const searchStatusMain = document.getElementById("search-status-main");
      const searchQueryDisplay = document.getElementById("search-query-display");
      const searchResultsSection = document.getElementById("search-results-section");

      const LIVE_SESSION_DOC_ID = "current_session";

      // ุงูุนูุงุตุฑ ุงูุฎุงุตุฉ ุจุงููุฏูุฑ
      const adminUsersApprovalSection = document.getElementById(
        "admin-users-approval"
      );
      const addLessonSection = document.getElementById("add-lesson-section");
      const addCharacterSection = document.getElementById(
        "add-character-section"
      );
      const addQuizSection = document.getElementById("add-quiz-section");
      const adminScoreEntrySection = document.getElementById("admin-score-entry-section");
      const adminGradesSection = document.getElementById("admin-grades-section");

      const liveSessionForm = document.getElementById("live-session-form");
      const liveSessionStatusMessageEl = document.getElementById(
        "live-session-status-message"
      );
      const lessonStatusMessageEl = document.getElementById(
        "lesson-status-message"
      );
      const charStatusMessageEl = document.getElementById(
        "char-status-message"
      );
      const quizStatusMessageEl = document.getElementById(
        "quiz-status-message"
      );
      const userSearchInput = document.getElementById("user-search-input");
      const pendingUsersList = document.getElementById("pending-users-list");
      const addLessonBtn = document.getElementById("add-lesson-btn");
      const addCharacterBtn = document.getElementById("add-character-btn");
      const addQuizBtn = document.getElementById("add-quiz-btn");
      const currentUserInfoEl = document.getElementById("access-status");

      // ุนูุงุตุฑ ุนุฑุถ ุงููุญุชูู
      const lessonsListEl = document.getElementById("lessons-list");
      const charactersListEl = document.getElementById("characters-list");
      const quizzesListEl = document.getElementById("quizzes-list");
      const navLiveSession = document.getElementById("nav-live-session");
      const lessonsSection = document.getElementById("lessons-section");
      const charactersSection = document.getElementById("characters-section");
      const quizzesSection = document.getElementById("quizzes-section");
      
      const navLessons = document.getElementById("nav-lessons");
      const navQuizzes = document.getElementById("nav-quizzes");
      const navCharacters = document.getElementById("nav-characters");
      
      // ูุชุบูุฑุงุช ุฎุงุตุฉ ุจุงููุฑุงุญู ุงูุชุนููููุฉ
      const gradesListAdmin = document.getElementById("grades-list-admin");
      let availableGrades = [];
      let currentGradeId = null; // ุงููุฑุญูุฉ ุงูุชุนููููุฉ ุงูุญุงููุฉ ูููุณุชุฎุฏู
      
      // ุญุงูุฉ ุงูุชุทุจูู
      let userId = null;
      let userData = null;
      let isAuthReady = false;
      let isUserAdmin = false;
      let isAdminMode = false;
      let unsubscribeUsers = null;
      let studentsProfiles = [];
      let allQuizzes = []; // ูุญูุธ ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช ูุงุณุชุฎุฏุงููุง ูู ุฑุตุฏ ุงูุฏุฑุฌุงุช

      // **********************************************
      // ************ ูุธุงุฆู ูุณุงุนุฏุฉ ููู UI ************
      // **********************************************

      function showMessage(element, message, isError = false) {
        if (!element) return;
        element.textContent = message;
        element.classList.remove("hidden", "text-yellow-300", "text-red-400");
        element.classList.add(isError ? "text-red-400" : "text-yellow-300");
        element.classList.remove("hidden");
        setTimeout(() => {
          element.classList.add("hidden");
        }, 5000);
      }

      window.closeAuthModal = function () {
        authModal.classList.add("opacity-0", "pointer-events-none");
        authModal.classList.remove("opacity-100");
        showMessage(authMessageBox, "", false);
      };
      
      window.closeGradeSelectorModal = function() {
        gradeSelectorModal.classList.add("opacity-0", "pointer-events-none");
        gradeSelectorModal.classList.remove("opacity-100");
        showMessage(gradeStatusMessage, "", false);
      }
      
      window.closeSearchModal = function() {
        searchModal.classList.add("opacity-0", "pointer-events-none");
        searchModal.classList.remove("opacity-100");
      }
      
      window.openSearchModal = function() {
          if (!userData?.isApproved) {
              showMessage(currentUserInfoEl, "ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ููุจุญุซ ูู ุงููุญุชูู.", true);
              return;
          }
          searchModal.classList.remove("opacity-0", "pointer-events-none", "hidden");
          searchModal.classList.add("opacity-100");
          // ุฅุฎูุงุก ุงููุชุงุฆุฌ ุนูุฏ ูุชุญ ุงููุงูุฐุฉ
          document.getElementById('search-status').textContent = 'ุงุจุฏุฃ ุจูุชุงุจุฉ ูููุฉ ููุจุญุซ...';
          document.getElementById('search-results-list').innerHTML = '';
      }


      function openAuthModal() {
        authTitle.textContent = "ุชุณุฌูู ุงูุฏุฎูู";
        loginForm.classList.remove("hidden");
        signupForm.classList.add("hidden");

        authModal.classList.remove(
          "opacity-0",
          "pointer-events-none",
          "hidden"
        );
        authModal.classList.add("opacity-100");
        showMessage(authMessageBox, "ุงูุฑุฌุงุก ุฅุฏุฎุงู ุจูุงูุงุชู.", false);
      }
      
      function openGradeSelectorModal() {
        gradeSelectorModal.classList.remove("opacity-0", "pointer-events-none", "hidden");
        gradeSelectorModal.classList.add("opacity-100");
        loadGradeSelectOptions(gradeLevelSelect);
      }
      
      function renderMainContent(show) {
          lessonsSection.classList.toggle('hidden', !show);
          charactersSection.classList.toggle('hidden', !show);
          quizzesSection.classList.toggle('hidden', !show);
          searchResultsSection.classList.add('hidden'); // ุฅุฎูุงุก ูุชุงุฆุฌ ุงูุจุญุซ ุนูุฏ ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ


          if (show) {
              loadLessons();
              loadCharacters();
              loadQuizzesAndResults();
          } else {
              lessonsListEl.innerHTML = charactersListEl.innerHTML = quizzesListEl.innerHTML = 
                `<p class="col-span-full text-center text-gray-500 py-10">ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ูุฑุญูุฉ ุชุนููููุฉ.</p>`;
          }
      }


      window.togglePasswordVisibility = function (iconElement) {
        const targetId = iconElement.getAttribute("data-target");
        const passwordInput = document.getElementById(targetId);
        if (passwordInput.type === "password") {
          passwordInput.type = "text";
          iconElement.classList.remove("fa-eye");
          iconElement.classList.add("fa-eye-slash");
        } else {
          passwordInput.type = "password";
          iconElement.classList.remove("fa-eye-slash");
          iconElement.classList.add("fa-eye");
        }
      };

      // **********************************************
      // ************ ููุทู ุชุจุฏูู ุงูููุงุฐุฌ ************
      // **********************************************

      document
        .getElementById("switch-to-signup")
        .addEventListener("click", (e) => {
          e.preventDefault();
          authTitle.textContent = "ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ";
          loginForm.classList.add("hidden");
          signupForm.classList.remove("hidden");
          showMessage(authMessageBox, "", false);
        });

      document
        .getElementById("switch-to-login")
        .addEventListener("click", (e) => {
          e.preventDefault();
          authTitle.textContent = "ุชุณุฌูู ุงูุฏุฎูู";
          signupForm.classList.add("hidden");
          loginForm.classList.remove("hidden");
          showMessage(authMessageBox, "", false);
        });

      // ****************************************************
      // ************ ููุทู Firebase Authentication ************
      // ****************************************************

      // 1. ุชุณุฌูู ุงูุฏุฎูู
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;
        showMessage(authMessageBox, "ุฌุงุฑู ุชุณุฌูู ุงูุฏุฎูู...", false);

        try {
          await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
          let errorMessage =
            "ุฎุทุฃ ูู ุชุณุฌูู ุงูุฏุฎูู. ุชุฃูุฏ ูู ุงูุจุฑูุฏ ููููุฉ ุงููุฑูุฑ.";
          if (
            error.code === "auth/wrong-password" ||
            error.code === "auth/user-not-found"
          ) {
            errorMessage = "ุจูุงูุงุช ุชุณุฌูู ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ.";
          } else if (error.code === "auth/network-request-failed") {
            errorMessage = "ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุดุจูุฉ. ูุฑุฌู ุงูุชุญูู ูู ุงุชุตุงูู.";
          }
          showMessage(authMessageBox, errorMessage, true);
        }
      });

      // 2. ุชุณุฌูู ุญุณุงุจ ุฌุฏูุฏ
      signupForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("signup-name").value.trim();
        const email = document.getElementById("signup-email").value;
        const password = document.getElementById("signup-password").value;

        if (password.length < 6) {
          showMessage(
            authMessageBox,
            "ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู.",
            true
          );
          return;
        }

        // ุชุญุฏูุฏ ุฏูุฑ ูููุงููุฉ ุงููุฏูุฑ ุจูุงุกู ุนูู ุงูุจูุงูุงุช ุงููุชูู ุนูููุง
        const is_admin_match = name === 'admin' && email === 'admin@gmail.com';
        const userRole = is_admin_match ? "admin" : "student";
        const isApprovedStatus = is_admin_match;

        signupSubmitBtn.disabled = true;
        showMessage(authMessageBox, "ุฌุงุฑู ุฅูุดุงุก ุงูุญุณุงุจ...", false);

        try {
          const userCredential = await createUserWithEmailAndPassword(
            auth,
            email,
            password
          );
          const user = userCredential.user;

          // ุชุญุฏูุซ ุงุณู ุงูุนุฑุถ
          if (user.displayName !== name) {
            await updateProfile(user, { displayName: name });
          }

          // ุญูุธ ููู ุชุนุฑูู ุงููุณุชุฎุฏู ูู Firestore
          await setDoc(doc(db, "artifacts", appId, "user_profiles", user.uid), {
            uid: user.uid,
            name: name,
            email: email,
            role: userRole,
            isApproved: isApprovedStatus,
            gradeLevel: null, // ุงููุฑุญูุฉ ุงูุชุนููููุฉ ุชููู ูุงุฑุบุฉ ูุจุฏุฆูุงู
            createdAt: new Date().toISOString(),
          });

          if (!isApprovedStatus) {
            await signOut(auth);
            showMessage(
              authMessageBox,
              "โ ุชู ุฅูุดุงุก ุญุณุงุจู ุจูุฌุงุญ. ูู ุชุชููู ูู ุงูุฏุฎูู ุฅูุง ุจุนุฏ ููุงููุฉ ุงููุฏูุฑ.",
              false
            );
            document.getElementById("switch-to-login").click();
          } else {
            closeAuthModal();
          }
        } catch (error) {
          let errorMessage = "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุณุฌูู.";
          if (error.code === "auth/email-already-in-use") {
            errorMessage = "ูุฐุง ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุณุชุฎุฏู ุจุงููุนู.";
          } else if (error.code === "auth/weak-password") {
            errorMessage =
              "ูููุฉ ุงููุฑูุฑ ุถุนููุฉ ุฌุฏุงู (ูุฌุจ ุฃู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู).";
          } else {
            errorMessage = `โ ูุดู ุญุฑุฌ ูู ุงูุชุณุฌูู: ${
              error.message
            }. (ููุฏ ุงูุฎุทุฃ: ${
              error.code || "ุบูุฑ ูุนุฑูู"
            }). ูุฑุฌู ุงูุชุญูู ูู ููุชุงุญ ุงูู API.`;
          }
          showMessage(authMessageBox, errorMessage, true);
        } finally {
          signupSubmitBtn.disabled = false;
        }
      });

      // 3. ุงูุฎุฑูุฌ ูู ุงูุญุณุงุจ
      function handleLogout() {
        signOut(auth).catch((error) => {
          console.error("Logout Error:", error);
        });
      }
      
      // **********************************************
      // ************ ููุทู ุงุฎุชูุงุฑ ุงููุฑุญูุฉ ุงูุชุนููููุฉ (ุฌุฏูุฏ) ************
      // **********************************************
      
      const GRADES_COLLECTION = collection(db, "artifacts", appId, "public", "data", "grade_levels");

      // ุชุญููู ุฎูุงุฑุงุช ุงููุฑุงุญู ุงูุชุนููููุฉ ูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ
      function loadGradeSelectOptions(selectElement) {
          selectElement.innerHTML = '<option value="">-- ูุฑุฌู ุงูุงุฎุชูุงุฑ --</option>';
          if (availableGrades.length > 0) {
              availableGrades.forEach(grade => {
                  const option = document.createElement('option');
                  option.value = grade.id;
                  option.textContent = grade.name;
                  if (grade.id === currentGradeId && selectElement.id === 'grade-level-select') {
                      option.selected = true; // ุชุญุฏูุฏ ุงูุฎูุงุฑ ุงูุญุงูู ูู modal ุงูุงุฎุชูุงุฑ
                  }
                  selectElement.appendChild(option);
              });
          }
      }

      // 1. ูุนุงูุฌุฉ ุชุญุฏูุซ ุงููุฑุญูุฉ ุงูุชุนููููุฉ ูู ุงูู Modal
      gradeSelectForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const selectedGradeId = gradeLevelSelect.value;
          
          if (!selectedGradeId) {
              showMessage(gradeStatusMessage, "ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ูุฑุญูุฉ ุชุนููููุฉ.", true);
              return;
          }

          if (!userId || !userData) {
             showMessage(gradeStatusMessage, "ุฎุทุฃ: ูุฌุจ ุฃู ุชููู ูุณุฌูุงู ููุฏุฎูู.", true);
             return;
          }
          
          // ุญูุธ ุงูุฎูุงุฑ ูู ููู ุงููุณุชุฎุฏู
          try {
              const userDocRef = doc(db, "artifacts", appId, "user_profiles", userId);
              await updateDoc(userDocRef, { gradeLevel: selectedGradeId });
              
              // ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ ูุฅุบูุงู ุงูู modal
              userData.gradeLevel = selectedGradeId;
              currentGradeId = selectedGradeId;
              closeGradeSelectorModal();
              
              showMessage(currentUserInfoEl, `โ ุชู ุชุญุฏูุซ ุงููุฑุญูุฉ ุงูุชุนููููุฉ ุจูุฌุงุญ!`, false);
              
              // ุฅุนุงุฏุฉ ุชุญููู ุงููุญุชูู ุงูุฎุงุต ุจูุฐุง ุงูุตู ุงูุฌุฏูุฏ
              renderMainContent(true);
              
          } catch (error) {
              showMessage(gradeStatusMessage, `โ ูุดู ุญูุธ ุงููุฑุญูุฉ: ${error.message}`, true);
          }
      });
      
      // 2. ุฅุฏุงุฑุฉ ุงููุฑุงุญู ุงูุชุนููููุฉ (ูููุฏูุฑ)
      document.getElementById('add-grade-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const name = document.getElementById('new-grade-name').value.trim();
          const statusEl = document.getElementById('grade-add-status-message');
          
          if (!isUserAdmin || !isAdminMode) {
              showMessage(statusEl, "ุบูุฑ ูุณููุญ. ุงููุฏูุฑ ููุท.", true);
              return;
          }
          if (!name) return;

          try {
              await addDoc(GRADES_COLLECTION, { name: name, createdAt: new Date().toISOString() });
              showMessage(statusEl, `โ ุชู ุฅุถุงูุฉ ุงููุฑุญูุฉ: ${name}`, false);
              document.getElementById('add-grade-form').reset();
          } catch (e) {
              showMessage(statusEl, `โ ุฎุทุฃ ูู ุงูุฅุถุงูุฉ: ${e.message}`, true);
          }
      });

      // 3. ุชุญููู ุงููุฑุงุญู ุงูุชุนููููุฉ ูู Firestore
      onSnapshot(GRADES_COLLECTION, (snapshot) => {
          availableGrades = [];
          gradesListAdmin.innerHTML = '';
          if (snapshot.empty) {
              gradesListAdmin.innerHTML = `<p class="text-gray-500">ูุง ุชูุฌุฏ ูุฑุงุญู ุชุนููููุฉ ูุถุงูุฉ ุญุงููุงู.</p>`;
              return;
          }
          
          snapshot.forEach(doc => {
              const grade = { id: doc.id, ...doc.data() };
              availableGrades.push(grade);
              
              // ุนุฑุถ ุจุทุงูุฉ ูููุฏูุฑ
              const card = document.createElement('div');
              card.className = 'flex justify-between items-center p-3 bg-gray-800 rounded-lg border gold-border/50';
              card.innerHTML = `
                  <span class="font-medium gold-color">${grade.name}</span>
                  <button 
                      data-id="${grade.id}" 
                      data-type="grade" 
                      class="py-1 px-3 rounded-md delete-btn text-white text-xs transition"
                  >
                      ุญุฐู
                  </button>
              `;
              gradesListAdmin.appendChild(card);
              card.querySelector('button').addEventListener('click', handleDelete);
          });
          
          // ุชุญุฏูุซ ุงูููุงุฆู ุงูููุณุฏูุฉ ูููุฏูุฑ (ุฅุถุงูุฉ ูุญุชูู)
          const gradeSelects = [
              document.getElementById('lesson-grade-select'),
              document.getElementById('char-grade-select'),
              document.getElementById('quiz-grade-select')
          ];
          gradeSelects.forEach(sel => loadGradeSelectOptions(sel));
          
      }, (error) => {
          console.error("Error loading grades:", error);
      });

      // ****************************************************
      // ************ ููุทู ุญุงูุฉ ุงููุณุชุฎุฏู (Auth State) ************
      // ****************************************************

      function toggleAdminUI(show) {
        // ุญูุงูุฉ: ุชู ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูุนูุงุตุฑ ููุง
        const adminSections = [
            adminUsersApprovalSection,
            addLessonSection,
            addCharacterSection,
            addQuizSection,
            adminScoreEntrySection,
            document.getElementById("admin-live-session-section"),
            adminGradesSection // ุฅุถุงูุฉ ูุณู ุฅุฏุงุฑุฉ ุงููุฑุงุญู ุงูุชุนููููุฉ
        ];
        
        adminSections.forEach(section => {
            if (section) {
                section.classList.toggle("hidden", !show);
            }
        });

        if (show) {
          loadAllUsers();
          loadStudentsForScoreEntry();
        } else if (unsubscribeUsers) {
          unsubscribeUsers();
          unsubscribeUsers = null;
        }
      }
      
      // ุฏุงูุฉ ุชุญุฏูุซ ุฃูุณุงู ุงููุญุชูู ุงูุฑุฆูุณูุฉ (ุงูุฏุฑูุณ/ุงูุดุฎุตูุงุช/ุงูุงุฎุชุจุงุฑุงุช)
      // ุชู ุฏูุฌ ูุฐู ุงูุฏุงูุฉ ูุฑุฉ ูุงุญุฏุฉ
      // function renderMainContent(show) { ... }


      onAuthStateChanged(auth, async (user) => {
        isAuthReady = true;
        userId = user ? user.uid : null;
        userData = null;

        if (user) {
          authIcon.classList.remove("fa-sign-in-alt");
          authIcon.classList.add("fa-sign-out-alt");
          authButton.onclick = handleLogout;

          const userDocRef = doc(db, "artifacts", appId, "user_profiles", user.uid);

          try {
            const userDoc = await getDoc(userDocRef);

            let profileData = null;
            if (userDoc.exists()) {
                profileData = userDoc.data();
            } else {
                console.log("User profile missing in Firestore. Creating default profile (Pending Student).");
                const defaultProfile = {
                    uid: user.uid, name: user.displayName || "ุทุงูุจ ุฌุฏูุฏ", email: user.email,
                    role: "student", isApproved: false, gradeLevel: null,
                    createdAt: new Date().toISOString(),
                };
                await setDoc(userDocRef, defaultProfile);
                profileData = defaultProfile;
            }
            
            // 3. ุงูุชุญูู ูู ุญุงูุฉ ุงููุฏูุฑ (ุฅุนุงุฏุฉ ูุญุต ุงูุจุฑูุฏ/ุงูุงุณู ุญุชู ูู ุชู ุฅูุดุงุก ุงูููู ูุฏููุงู)
            if (profileData.email === 'admin@gmail.com') { 
                if (profileData.role !== 'admin' || profileData.isApproved !== true) {
                    await updateDoc(userDocRef, { role: 'admin', isApproved: true });
                    profileData.role = 'admin';
                    profileData.isApproved = true;
                }
            }
            
            userData = profileData;
            currentGradeId = userData.gradeLevel; // ุชุนููู ุงููุฑุญูุฉ ุงูุญุงููุฉ ูููุณุชุฎุฏู

            const role = userData.role || "pending";
            const isApproved = userData.isApproved === true;
            isUserAdmin = role === "admin" && isApproved;

            // 4. ุชุญุฏูุซ UI ูุนุฑุถ ุงููุญุชูู
            if (isApproved) {
              closeAuthModal(); 
              heroSection.classList.remove("opacity-50");
              accessStatus.classList.add("hidden");

              adminToggleBtn.classList.toggle("hidden", !isUserAdmin);
              adminToggleBtn.textContent = isAdminMode ? "(User View)" : "(Admin Mode)";
              toggleAdminUI(isAdminMode && isUserAdmin);
              loadLiveSession(); // ุชุญููู ุฑุงุจุท ุงูุจุซ ุงููุจุงุดุฑ

              // ููุทู ุธููุฑ ุงููุญุชูู ุจูุงุกู ุนูู ุงุฎุชูุงุฑ ุงููุฑุญูุฉ
              if (currentGradeId || isUserAdmin) {
                  renderMainContent(true); // ุฅุฐุง ุงุฎุชุงุฑ ุตูุงู ุฃู ูุงู ูุฏูุฑุงูุ ุฃุธูุฑ ุงููุญุชูู
              } else {
                  renderMainContent(false); // ุฅุฎูุงุก ุงููุญุชูู
                  openGradeSelectorModal(); // ุงูุชุญ ูุงูุฐุฉ ุงุฎุชูุงุฑ ุงููุฑุญูุฉ
              }
              
            } else {
              // ุฏูุฑ pending (ุนุฑุถ ุญุงูุฉ ุงูุงูุชุธุงุฑ)
              heroSection.classList.add("opacity-50");
              accessStatus.classList.remove("hidden");
              accessStatus.textContent = `โ๏ธ ุญุณุงุจู ููุฏ ุงููุฑุงุฌุนุฉ. ููุฑุฌู ุงูุชุธุงุฑ ููุงููุฉ ุงููุฏูุฑ ูููุตูู ุฅูู ุงููุญุชูู.`;
              adminToggleBtn.classList.add("hidden");
              toggleAdminUI(false);
              navLiveSession.classList.add("hidden");
              renderMainContent(false);
            }
            
          } catch (error) {
            console.error("Error fetching or creating user profile:", error);
            showMessage(currentUserInfoEl, `ุฎุทุฃ ูู ุฌูุจ ุจูุงูุงุช ูููู ุงูุดุฎุตู. ุชุญูู ูู ููุงุนุฏ Firestore: ${error.message}`, true);
          }
        } else {
          // ูุง ููุฌุฏ ูุณุชุฎุฏู ูุณุฌู (ุญุงูุฉ ุงูุฎุฑูุฌ)
          isUserAdmin = false; isAdminMode = false; userData = null;
          authIcon.classList.remove("fa-sign-out-alt"); authIcon.classList.add("fa-sign-in-alt");
          authButton.onclick = openAuthModal;
          heroSection.classList.add("opacity-50"); accessStatus.classList.remove("hidden");
          accessStatus.textContent = `๐ ููุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูููุตูู ุฅูู ุงููุญุชูู.`;
          adminToggleBtn.classList.add("hidden"); toggleAdminUI(false); navLiveSession.classList.add("hidden");
          renderMainContent(false); // ุฅุฎูุงุก ุงููุญุชูู ุงูุฑุฆูุณู
        }
      });

      // 5. ูุนุงูุฌุฉ ุงูุชุจุฏูู ุจูู ูุถุน ุงููุฏูุฑ ููุถุน ุงููุณุชุฎุฏู
      adminToggleBtn.addEventListener("click", () => {
        if (isUserAdmin) {
          isAdminMode = !isAdminMode;
          adminToggleBtn.textContent = isAdminMode
            ? "(User View)"
            : "(Admin Mode)";
          toggleAdminUI(isAdminMode);
          renderMainContent(true);
        }
      });

      // **********************************************
      // ************ ููุทู ุงูุชููู ุนูู ุงูููุงุชู ************
      // **********************************************

      const mobileMenuButton = document.getElementById("mobile-menu-button");
      const mainNavLinks = document.getElementById("main-nav-links");

      if (mobileMenuButton && mainNavLinks) {
        mobileMenuButton.addEventListener("click", () => {
          mainNavLinks.classList.toggle("hidden");
          const icon = mobileMenuButton.querySelector("i");
          if (mainNavLinks.classList.contains("hidden")) {
            icon.classList.remove("fa-times");
            icon.classList.add("fa-bars");
          } else {
            icon.classList.remove("fa-bars");
            icon.classList.add("fa-times");
          }
        });

        mainNavLinks.querySelectorAll("a").forEach((link) => {
          link.addEventListener("click", () => {
            if (!mainNavLinks.classList.contains("hidden")) {
              mobileMenuButton.click();
            }
          });
        });
      }

      // **************** ุฏุงูุฉ ูุนุงูุฌุฉ ุงูููุฑ ุนูู ุฑูุงุจุท ุงูู Navbar ****************
      function handleNavClick(e) {
          e.preventDefault();
          
          if (!userData?.isApproved || (userData.role === 'student' && !currentGradeId)) {
              openGradeSelectorModal();
              return;
          }
          
          const targetSectionId = e.currentTarget.getAttribute('href');
          const targetSection = document.querySelector(targetSectionId);
          
          // ุฅุธูุงุฑ ุงููุญุชูู ุงูุฑุฆูุณู ุฃููุงู
          renderMainContent(true); 

          // ุฅุฎูุงุก ุฌููุน ุฃูุณุงู ุงููุญุชูู
          lessonsSection.classList.add('hidden');
          charactersSection.classList.add('hidden');
          quizzesSection.classList.add('hidden');
          searchResultsSection.classList.add('hidden'); // ุฅุฎูุงุก ูุชุงุฆุฌ ุงูุจุญุซ ุนูุฏ ุงูุงูุชูุงู

          
          // ุฅุธูุงุฑ ุงููุณู ุงููุทููุจ
          if (targetSection) {
              targetSection.classList.remove('hidden');
          }
          
          // ุฅุนุงุฏุฉ ุชุญููู ุจูุงูุงุช ุงููุณู ุงููุทููุจ ุฅุฐุง ูุฒู ุงูุฃูุฑ
          if (targetSectionId === '#lessons-section') loadLessons();
          if (targetSectionId === '#characters-section') loadCharacters();
          if (targetSectionId === '#quizzes-section') loadQuizzesAndResults();
          
          
      }
      
      document.querySelectorAll('#main-nav-links a').forEach(link => {
        // ูุฑุจุท ุงูู links ุจูุธููุชูุง ุงูุฌุฏูุฏุฉ
        link.addEventListener('click', handleNavClick);
      });
      
      // **********************************************
      // ************ ูุธุงุฆู ุฅุฏุงุฑุฉ ุงููุญุชูู ูุงููุชุงุฆุฌ ************
      // **********************************************

      // **************** ุฏุงูุฉ ุงูุจุญุซ ุงูุนุงู ****************
      document.getElementById('global-search-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const queryText = searchInput.value.trim();
          
          if (queryText.length < 2) {
              document.getElementById('search-status').textContent = 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุญุฑููู ุนูู ุงูุฃูู ููุจุญุซ.';
              return;
          }
          
          closeSearchModal(); // ุฅุบูุงู ูุงูุฐุฉ ุงูุจุญุซ
          renderMainContent(false); // ุฅุฎูุงุก ุฃูุณุงู ุงููุญุชูู ุงูุฑุฆูุณูุฉ
          searchResultsSection.classList.remove('hidden'); // ุฅุธูุงุฑ ูุณู ูุชุงุฆุฌ ุงูุจุญุซ
          searchQueryDisplay.textContent = queryText;
          searchStatusMain.textContent = 'ุฌุงุฑู ุงูุจุญุซ ูู ุฌููุน ุงููุฑุงุญู...';
          document.getElementById('search-results-output').innerHTML = '';

          try {
              const collections = ['history_lessons', 'historical_characters', 'quizzes'];
              let allResults = [];
              const lowerCaseQuery = queryText.toLowerCase();

              const searchInCollection = async (collectionName, titleKey, summaryKey) => {
                  const ref = collection(db, "artifacts", appId, "public", "data", collectionName);
                  const docsSnapshot = await getDocs(ref);
                  
                  docsSnapshot.forEach(docSnap => {
                      const data = docSnap.data();
                      const docId = docSnap.id;
                      
                      const matchesGrade = isUserAdmin || !currentGradeId || data.gradeLevel === currentGradeId;
                      
                      if (matchesGrade && (data[titleKey]?.toLowerCase().includes(lowerCaseQuery) || data[summaryKey]?.toLowerCase().includes(lowerCaseQuery))) {
                           allResults.push({ id: docId, type: collectionName, ...data });
                      }
                  });
              };
              
              await searchInCollection('history_lessons', 'title', 'summary');
              await searchInCollection('historical_characters', 'name', 'bio');
              await searchInCollection('quizzes', 'title', 'description');


              searchStatusMain.textContent = `ุชู ุงูุนุซูุฑ ุนูู ${allResults.length} ูุชุงุฆุฌ ูุทุงุจูุฉ ูู "${queryText}"`;
              
              if (allResults.length === 0) {
                   document.getElementById('search-results-output').innerHTML = `<p class="text-gray-500 text-center">ูู ูุชู ุงูุนุซูุฑ ุนูู ูุชุงุฆุฌ ูุทุงุจูุฉ.</p>`;
                   return;
              }
              
              // ุนุฑุถ ุงููุชุงุฆุฌ
              const outputEl = document.getElementById('search-results-output');
              outputEl.innerHTML = '';
              
              allResults.forEach(result => {
                  const card = document.createElement('div');
                  const gradeName = availableGrades.find(g => g.id === result.gradeLevel)?.name || 'ุบูุฑ ูุญุฏุฏ';
                  
                  let icon, color, subtitle, linkHtml = '';

                  if (result.type === 'history_lessons') {
                      icon = 'fa-book-open'; color = 'gold-color'; subtitle = 'ุฏุฑุณ';
                      linkHtml = `<a href="#lessons-section" onclick="handleNavClick({currentTarget: {getAttribute: () => '#lessons-section'}})" class="text-sm text-yellow-500 hover:underline ml-3"><i class="fas fa-eye ml-1"></i> ุนุฑุถ</a>`;
                  } else if (result.type === 'historical_characters') {
                      icon = 'fa-user-friends'; color = 'text-purple-400'; subtitle = 'ุดุฎุตูุฉ ุชุงุฑูุฎูุฉ';
                      linkHtml = `<a href="#characters-section" onclick="handleNavClick({currentTarget: {getAttribute: () => '#characters-section'}})" class="text-sm text-yellow-500 hover:underline ml-3"><i class="fas fa-eye ml-1"></i> ุนุฑุถ</a>`;
                  } else if (result.type === 'quizzes') {
                      icon = 'fa-clipboard-list'; color = 'text-green-400'; subtitle = 'ุงุฎุชุจุงุฑ';
                      linkHtml = `<a href="${result.googleFormUrl}" target="_blank" class="text-sm text-green-400 hover:underline ml-3"><i class="fas fa-external-link-alt ml-1"></i> ุงุจุฏุฃ ุงูุงุฎุชุจุงุฑ</a>`;
                  }
                  
                  card.className = `p-4 bg-gray-900 rounded-xl gold-shadow flex justify-between items-start`;
                  card.innerHTML = `
                      <div>
                          <div class="flex items-center space-x-2 space-x-reverse mb-1">
                              <i class="fas ${icon} ${color}"></i>
                              <span class="text-xs text-gray-500">${subtitle} (${gradeName})</span>
                          </div>
                          <h5 class="text-lg font-bold text-white">${result.title || result.name}</h5>
                          <p class="text-sm text-gray-400 mt-1">${result.summary || result.bio || result.description || 'ูุง ููุฌุฏ ูุตู.'}</p>
                      </div>
                      <div class="mt-2">${linkHtml}</div>
                  `;
                  outputEl.appendChild(card);
              });


          } catch (error) {
              console.error("Error during global search:", error);
              searchStatusMain.textContent = `โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุจุญุซ: ${error.message}`;
          }
      });
      
      // **************** ุฏุงูุฉ ุชุญููู ูุนุฑุถ ุงูุฏุฑูุณ (ูุน ุชุตููุฉ ุงูุตู) ****************
      function loadLessons() {
        // ุฅุฐุง ูุงู ุทุงูุจุงู ููู ูุฎุชุฑ ุตูุงูุ ูุง ูุญูู ุดูุฆุงู
        if (!db || !isAuthReady || userData?.isApproved !== true || (userData.role === 'student' && !currentGradeId)) {
             lessonsListEl.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ูุฑุญูุฉ ุชุนููููุฉ ูุนุฑุถ ุงูุฏุฑูุณ.</p>`;
             return;
        }

        const lessonsRef = collection(db, "artifacts", appId, "public", "data", "history_lessons");
        
        let lessonsQuery = query(lessonsRef, limit(50));
        
        // ุชุตููุฉ ุญุณุจ ุงููุฑุญูุฉ ุงูุชุนููููุฉ ุฅุฐุง ูู ููู ูุฏูุฑุงู
        if (userData.role !== 'admin' && currentGradeId) {
            lessonsQuery = query(lessonsRef, where("gradeLevel", "==", currentGradeId), limit(50));
        } else if (isAdminMode && isUserAdmin) {
            // ุงููุฏูุฑ ูู ูุถุน ุงูุฅุฏุงุฑุฉ ูุฑู ูู ุดูุก
             lessonsQuery = query(lessonsRef, limit(100)); 
        } else if (userData.role === 'student' && currentGradeId) {
             lessonsQuery = query(lessonsRef, where("gradeLevel", "==", currentGradeId), limit(50));
        }

        onSnapshot(
          lessonsQuery,
          (snapshot) => {
            lessonsListEl.innerHTML = "";
            document.getElementById("lessons-loading-status").classList.add("hidden");

            if (snapshot.empty) {
              lessonsListEl.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">ูุง ุชูุฌุฏ ุฏุฑูุณ ุญุงููุงู ููุฐู ุงููุฑุญูุฉ.</p>`;
              return;
            }

            snapshot.forEach((doc) => {
              renderLesson(doc.id, doc.data());
            });
          },
          (error) => {
            console.error("Error listening to Firestore lessons:", error);
            document.getElementById("lessons-loading-status").textContent = "ุฎุทุฃ ูู ุชุญููู ุงูุฏุฑูุณ.";
          }
        );
      }

      // **************** ุฏุงูุฉ ุนุฑุถ ุจุทุงูุฉ ุงูุฏุฑุณ ****************
      function renderLesson(docId, data) {
        const card = document.createElement("div");
        card.className =
          "lesson-card p-6 bg-gray-900 rounded-xl gold-shadow flex flex-col justify-between";
        card.dataset.docId = docId;
        
        // ุฌูุจ ุงุณู ุงููุฑุญูุฉ ุงูุชุนููููุฉ ููุนุฑุถ
        const gradeName = availableGrades.find(g => g.id === data.gradeLevel)?.name || 'ุบูุฑ ูุญุฏุฏ';


        let mediaLinks = "";
        if (data.pdfUrl) {
          mediaLinks += `<a href="${data.pdfUrl}" target="_blank" class="text-sm gold-color hover:text-yellow-500 transition ml-4"><i class="fas fa-file-pdf ml-1"></i> ูุฑุงุกุฉ PDF</a>`;
        }
        if (data.videoUrl) {
          mediaLinks += `<a href="${data.videoUrl}" target="_blank" class="text-sm gold-color hover:text-yellow-500 transition"><i class="fas fa-video ml-1"></i> ูุดุงูุฏุฉ ููุฏูู</a>`;
        }

        const showDeleteButton = isAdminMode && isUserAdmin;

        const content = `
              <div>
                  <span class="text-xs text-gray-500 mb-1 block">ุงููุฑุญูุฉ: ${gradeName}</span>
                  <h3 class="text-xl font-bold gold-color mb-2">${
                    data.title || "ุฏุฑุณ ุจุฏูู ุนููุงู"
                  }</h3>
                  <p class="text-sm text-gray-400 mb-4">${
                    data.summary || "ูุง ููุฌุฏ ููุฎุต."
                  }</p>
              </div>
              <div class="flex justify-between items-center pt-3 border-t border-gray-700/50 mt-4">
                  <div class="flex items-center space-x-4 space-x-reverse">${mediaLinks}</div>
                  ${
                    showDeleteButton
                      ? `<button data-doc-id="${docId}" data-type="lesson" class="py-1 px-3 rounded-md delete-btn text-white text-sm transition">ุญุฐู</button>`
                      : `<span class="text-xs text-gray-500">ููุดูุฑ ุจูุงุณุทุฉ ุงููุฏูุฑ</span>`
                  }
              </div>
          `;
        card.innerHTML = content;
        lessonsListEl.appendChild(card);

        if (showDeleteButton) {
          card
            .querySelector(".delete-btn")
            ?.addEventListener("click", handleDelete);
        }
      }

      // **************** ุฏุงูุฉ ุฅุถุงูุฉ ุฏุฑุณ ุฌุฏูุฏ (ููุนุงูุฌุฉ ุงููููุฐุฌ) ****************
      document
        .getElementById("add-lesson-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!isUserAdmin || !isAdminMode) {
            showMessage(
              lessonStatusMessageEl,
              "ุบูุฑ ูุณููุญ. ูููู ูููุฏูุฑ ููุท ุงูุฅุถุงูุฉ.",
              true
            );
            return;
          }

          const gradeLevel = document.getElementById("lesson-grade-select").value;
          const title = document.getElementById("lesson-title").value;
          const summary = document.getElementById("lesson-summary").value;
          const pdfUrl = document.getElementById("lesson-pdf-url").value;
          const videoUrl = document.getElementById("lesson-video-url").value;
          
          if (!gradeLevel) {
               showMessage(lessonStatusMessageEl, "ูุฌุจ ุชุญุฏูุฏ ุงููุฑุญูุฉ ุงูุชุนููููุฉ.", true);
               return;
          }


          addLessonBtn.disabled = true;
          showMessage(lessonStatusMessageEl, "ุฌุงุฑู ุญูุธ ุงูุฏุฑุณ...", false);

          try {
            const lessonsRef = collection(
              db,
              "artifacts",
              appId,
              "public",
              "data",
              "history_lessons"
            );
            await addDoc(lessonsRef, {
              gradeLevel: gradeLevel, // ุฅุถุงูุฉ ุงููุฑุญูุฉ ุงูุชุนููููุฉ
              title: title,
              summary: summary,
              pdfUrl: pdfUrl,
              videoUrl: videoUrl,
              authorId: userId,
              createdAt: new Date().toISOString(),
            });

            showMessage(
              lessonStatusMessageEl,
              "โ ุชู ุฅุถุงูุฉ ุงูุฏุฑุณ ุจูุฌุงุญ!",
              false
            );
            document.getElementById("add-lesson-form").reset();
          } catch (e) {
            console.error("Error adding document: ", e);
            showMessage(
              lessonStatusMessageEl,
              `โ ุฎุทุฃ ูู ุงูุฅุถุงูุฉ: ${e.message}. ูุฑุฌู ูุฑุงุฌุนุฉ ููุงุนุฏ ุฃูุงู Firestore.`,
              true
            );
          } finally {
            addLessonBtn.disabled = false;
          }
        });

      // **************** ุฏุงูุฉ ุชุญููู ูุนุฑุถ ุงูุดุฎุตูุงุช ุงูุชุงุฑูุฎูุฉ (ูุน ุชุตููุฉ ุงูุตู) ****************
      function loadCharacters() {
        if (!db || !isAuthReady || userData?.isApproved !== true || (userData.role === 'student' && !currentGradeId)) {
            charactersListEl.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ูุฑุญูุฉ ุชุนููููุฉ ูุนุฑุถ ุงูุดุฎุตูุงุช.</p>`;
            return;
        }

        const charsRef = collection(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "historical_characters"
        );
        let charsQuery = query(charsRef, limit(50));
        
        // ุชุตููุฉ ุญุณุจ ุงููุฑุญูุฉ ุงูุชุนููููุฉ
        if (userData.role !== 'admin' && currentGradeId) {
             charsQuery = query(charsRef, where("gradeLevel", "==", currentGradeId), limit(50));
        } else if (userData.role === 'student' && currentGradeId) {
             charsQuery = query(charsRef, where("gradeLevel", "==", currentGradeId), limit(50));
        }


        onSnapshot(
          charsQuery,
          (snapshot) => {
            charactersListEl.innerHTML = "";
            document
              .getElementById("characters-loading-status")
              .classList.add("hidden");

            if (snapshot.empty) {
              charactersListEl.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">ูุง ุชูุฌุฏ ุดุฎุตูุงุช ุญุงููุงู ููุฐู ุงููุฑุญูุฉ.</p>`;
              return;
            }

            snapshot.forEach((doc) => {
              renderCharacter(doc.id, doc.data());
            });
          },
          (error) => {
            console.error("Error listening to Firestore characters:", error);
            document.getElementById("characters-loading-status").textContent =
              "ุฎุทุฃ ูู ุชุญููู ุงูุดุฎุตูุงุช.";
          }
        );
      }

      // **************** ุฏุงูุฉ ุนุฑุถ ุจุทุงูุฉ ุงูุดุฎุตูุฉ ****************
      function renderCharacter(docId, data) {
        const card = document.createElement("div");
        card.className =
          "char-card p-4 bg-gray-900 rounded-xl gold-shadow flex flex-col justify-between items-start";
        card.dataset.docId = docId;

        const showDeleteButton = isAdminMode && isUserAdmin;
        const gradeName = availableGrades.find(g => g.id === data.gradeLevel)?.name || 'ุบูุฑ ูุญุฏุฏ';


        const content = `
              <i class="fas fa-crown gold-color text-2xl mb-2"></i>
              <h3 class="text-lg font-bold text-white mb-1">${
                data.name || "ุดุฎุตูุฉ ุบูุฑ ูุนุฑููุฉ"
              }</h3>
              <p class="text-sm gold-color mb-2">${
                data.era || "ุญูุจุฉ ุบูุฑ ูุญุฏุฏุฉ"
              }</p>
              <p class="text-xs text-gray-400 mb-4 line-clamp-4">${
                data.bio || "ูุง ููุฌุฏ ูุจุฐุฉ."
              }</p>
              <span class="text-xs text-gray-500 mt-auto">ุงููุฑุญูุฉ: ${gradeName}</span>


              ${
                showDeleteButton
                  ? `<button data-doc-id="${docId}" data-type="character" class="py-1 px-3 rounded-md delete-btn text-white text-xs transition mt-2 self-end">ุญุฐู</button>`
                  : ""
              }
          `;
        card.innerHTML = content;
        charactersListEl.appendChild(card);

        if (showDeleteButton) {
          card
            .querySelector(".delete-btn")
            ?.addEventListener("click", handleDelete);
        }
      }

      // **************** ุฏุงูุฉ ุฅุถุงูุฉ ุดุฎุตูุฉ ุฌุฏูุฏุฉ (ููุนุงูุฌุฉ ุงููููุฐุฌ) ****************
      document
        .getElementById("add-character-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!isUserAdmin || !isAdminMode) {
            showMessage(
              charStatusMessageEl,
              "ุบูุฑ ูุณููุญ. ูููู ูููุฏูุฑ ููุท ุงูุฅุถุงูุฉ.",
              true
            );
            return;
          }

          const gradeLevel = document.getElementById("char-grade-select").value;
          const name = document.getElementById("char-name").value;
          const era = document.getElementById("char-era").value;
          const bio = document.getElementById("char-bio").value;
          
          if (!gradeLevel) {
               showMessage(charStatusMessageEl, "ูุฌุจ ุชุญุฏูุฏ ุงููุฑุญูุฉ ุงูุชุนููููุฉ.", true);
               return;
          }

          if (!name || !era || !bio) {
            showMessage(
              charStatusMessageEl,
              "ูุฌุจ ููุก ุฌููุน ุญููู ุงูุดุฎุตูุฉ.",
              true
            );
            return;
          }

          addCharacterBtn.disabled = true;
          showMessage(charStatusMessageEl, "ุฌุงุฑู ุญูุธ ุงูุดุฎุตูุฉ...", false);

          try {
            const charsRef = collection(
              db,
              "artifacts",
              appId,
              "public",
              "data",
              "historical_characters"
            );

            await addDoc(charsRef, {
              gradeLevel: gradeLevel, // ุฅุถุงูุฉ ุงููุฑุญูุฉ ุงูุชุนููููุฉ
              name: name,
              era: era,
              bio: bio,
              authorId: userId,
              createdAt: new Date().toISOString(),
            });

            showMessage(
              charStatusMessageEl,
              "โ ุชู ุฅุถุงูุฉ ุงูุดุฎุตูุฉ ุจูุฌุงุญ!",
              false
            );
            document.getElementById("add-character-form").reset();
          } catch (e) {
            console.error("Error adding character: ", e);
            showMessage(
              charStatusMessageEl,
              `โ ุฎุทุฃ ูู ุงูุฅุถุงูุฉ: ${e.message}. ูุฑุฌู ูุฑุงุฌุนุฉ ููุงุนุฏ ุฃูุงู Firestore.`,
              true
            );
          } finally {
            addCharacterBtn.disabled = false;
          }
        });

      // **************** ุฏุงูุฉ ุฅุฏุงุฑุฉ ุงูุฌูุณุฉ ุงููุจุงุดุฑุฉ ****************
      const LIVE_SESSION_REF = doc(
        db,
        "artifacts",
        appId,
        "public",
        "data",
        "live_session",
        LIVE_SESSION_DOC_ID
      );

      function loadLiveSession() {
        if (!db || !isAuthReady || userData?.isApproved !== true) {
          navLiveSession.classList.add("hidden");
          return;
        }

        onSnapshot(LIVE_SESSION_REF, (docSnap) => {
          if (docSnap.exists() && docSnap.data().url) {
            const data = docSnap.data();

            navLiveSession.href = data.url;
            navLiveSession.target = "_blank";
            navLiveSession.classList.remove("hidden");
            navLiveSession.title =
              data.description || "ุงุถุบุท ููุงูุถูุงู ุฅูู ุงูุจุซ ุงููุจุงุดุฑ!";

            if (isUserAdmin && isAdminMode) {
              document.getElementById("live-session-url").value = data.url;
              document.getElementById("live-session-desc").value =
                data.description || "";
            }
          } else {
            navLiveSession.classList.add("hidden");
          }
        });
      }

      // ุฏุงูุฉ ุญูุธ/ุชุญุฏูุซ ุฑุงุจุท ุงูุฌูุณุฉ ุงููุจุงุดุฑุฉ (ูููุฏูุฑ ููุท)
      liveSessionForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!isUserAdmin || !isAdminMode) {
          showMessage(
            liveSessionStatusMessageEl,
            "ุบูุฑ ูุณููุญ. ูููู ูููุฏูุฑ ููุท ุงูุชุญุฏูุซ.",
            true
          );
          return;
        }

        const url = document.getElementById("live-session-url").value;
        const description = document.getElementById("live-session-desc").value;

        if (!url) {
          showMessage(liveSessionStatusMessageEl, "ุงูุฑุงุจุท ุฅูุฒุงูู.", true);
          return;
        }

        document.getElementById("update-live-session-btn").disabled = true;
        showMessage(
          liveSessionStatusMessageEl,
          "ุฌุงุฑู ุญูุธ ุฑุงุจุท ุงูุฌูุณุฉ...",
          false
        );

        try {
          await setDoc(LIVE_SESSION_REF, {
            url: url,
            description: description,
            updatedBy: userId,
            updatedAt: new Date().toISOString(),
          });

          showMessage(
            liveSessionStatusMessageEl,
            "โ ุชู ุชุญุฏูุซ ุฑุงุจุท ุงูุฌูุณุฉ ุงููุจุงุดุฑุฉ ุจูุฌุงุญ!",
            false
          );
        } catch (e) {
          console.error("Error updating live session: ", e);
          showMessage(
            liveSessionStatusMessageEl,
            `โ ุฎุทุฃ ูู ุงูุชุญุฏูุซ: ${e.message}. ูุฑุฌู ูุฑุงุฌุนุฉ ููุงุนุฏ ุฃูุงู Firestore.`,
            true
          );
        } finally {
          document.getElementById("update-live-session-btn").disabled = false;
        }
      });

      // **************** ุฏุงูุฉ ุชุญููู ุงูุงุฎุชุจุงุฑุงุช ูุงููุชุงุฆุฌ (ูุน ุชุตููุฉ ุงูุตู) ****************
      function loadQuizzesAndResults() {
        if (!db || !isAuthReady || userData?.isApproved !== true || (userData.role === 'student' && !currentGradeId)) {
            quizzesListEl.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ูุฑุญูุฉ ุชุนููููุฉ ูุนุฑุถ ุงูุงุฎุชุจุงุฑุงุช.</p>`;
            return;
        }

        document.getElementById("quizzes-title").textContent =
          isUserAdmin && isAdminMode
            ? "ุงูุงุฎุชุจุงุฑุงุช (ููุญุฉ ุชุญูู ุงููุฏูุฑ)"
            : `ูุชุงุฆุฌู (${userData?.name || "ุทุงูุจ"})`;
        document
          .getElementById("quizzes-loading-status")
          .classList.remove("hidden");
        quizzesListEl.innerHTML = "";

        const quizzesRef = collection(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "quizzes"
        );
        const resultsRef = collection(
          db,
          "artifacts",
          appId,
          "users",
          userId,
          "quiz_results"
        );

        let quizzesQuery = query(quizzesRef);
        // ุชุตููุฉ ุญุณุจ ุงููุฑุญูุฉ ุงูุชุนููููุฉ
        if (userData.role !== 'admin' && currentGradeId) {
             quizzesQuery = query(quizzesRef, where("gradeLevel", "==", currentGradeId), limit(50));
        } else if (userData.role === 'student' && currentGradeId) {
             quizzesQuery = query(quizzesRef, where("gradeLevel", "==", currentGradeId), limit(50));
        }

        onSnapshot(
          resultsRef,
          (resultsSnapshot) => {
            const resultsMap = {};
            resultsSnapshot.forEach((doc) => {
              resultsMap[doc.id] = doc.data();
            });

            onSnapshot(quizzesQuery, (quizSnapshot) => {
              document
                .getElementById("quizzes-loading-status")
                .classList.add("hidden");
              quizzesListEl.innerHTML = "";
              allQuizzes = []; // ุชุญุฏูุซ ุงููุงุฆูุฉ ุงูุนุงูุฉ ููุงุฎุชุจุงุฑุงุช
              quizSnapshot.forEach((doc) => {
                allQuizzes.push({ id: doc.id, ...doc.data() });
              });

              if (allQuizzes.length === 0) {
                quizzesListEl.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช ูุชุงุญุฉ ุญุงููุงู ููุฐู ุงููุฑุญูุฉ.</p>`;
                return;
              }

              allQuizzes.forEach((quiz) => {
                if (!isUserAdmin || !isAdminMode) {
                  renderStudentResult(quiz, resultsMap[quiz.id]);
                } else {
                  renderQuizCardForAdmin(quiz);
                }
              });
              
              updateQuizSelectOptions();
              
            });
          },
          (error) => {
            console.error("Error loading quiz results/quizzes:", error);
            document.getElementById("quizzes-loading-status").textContent =
              "ุฎุทุฃ ูู ุชุญููู ุงูุงุฎุชุจุงุฑุงุช/ุงููุชุงุฆุฌ.";
          }
        );
      }

      // **************** ุฏุงูุฉ ุนุฑุถ ุจุทุงูุฉ ูุชูุฌุฉ ุงูุทุงูุจ ****************
      function renderStudentResult(quiz, result) {
        const card = document.createElement("div");
        card.className =
          "quiz-card p-6 bg-gray-900 rounded-xl gold-shadow flex flex-col justify-between";

        const scoreText = result
          ? `<span class="text-2xl font-bold gold-color">${result.score} / ${quiz.maxScore}</span>`
          : `<span class="text-sm text-red-500">ูู ูุชู ุฑุตุฏ ุฏุฑุฌุฉ ุจุนุฏ.</span>`;
        
        const gradeName = availableGrades.find(g => g.id === quiz.gradeLevel)?.name || 'ุบูุฑ ูุญุฏุฏ';


        const content = `
              <div class="flex justify-between items-start mb-2">
                  <h3 class="text-xl font-bold text-white">${quiz.title}</h3>
                  <a href="${
                    quiz.googleFormUrl
                  }" target="_blank" rel="noopener noreferrer"
                     class="live-btn py-2 px-4 rounded-lg text-white font-bold text-sm flex items-center gold-shadow hover:bg-green-600 transition">
                      <i class="fas fa-external-link-alt ml-2"></i> ุงุจุฏุฃ ุงูุงุฎุชุจุงุฑ (Google Form)
                  </a>
              </div>
              <p class="text-sm text-gray-400 mb-3">${quiz.description}</p>
              <div class="flex justify-between items-center pt-3 border-t border-gray-700/50 mt-2">
                  <p class="text-sm text-gray-500">ุฏุฑุฌุชู ุงููุณุฌูุฉ: (${gradeName})</p>
                  ${scoreText}
              </div>
              ${
                result?.notes
                  ? `<p class="text-xs text-gray-400 mt-2">ููุงุญุธุงุช ุงููุฏูุฑ: ${result.notes}</p>`
                  : ""
              }
          `;
        card.innerHTML = content;
        quizzesListEl.appendChild(card);
      }

      // **************** ุฏุงูุฉ ุนุฑุถ ุจุทุงูุฉ ุงูุงุฎุชุจุงุฑ ูููุฏูุฑ ****************
      function renderQuizCardForAdmin(quiz) {
        const card = document.createElement("div");
        card.className =
          "quiz-card p-4 bg-gray-800 rounded-xl gold-border border flex justify-between items-center";
          
        const gradeName = availableGrades.find(g => g.id === quiz.gradeLevel)?.name || 'ุบูุฑ ูุญุฏุฏ';


        const content = `
              <div>
                  <h3 class="text-lg font-bold gold-color">${quiz.title}</h3>
                  <p class="text-sm text-gray-400">ุงูุฏุฑุฌุฉ ุงููููุฉ: ${quiz.maxScore} | ุงููุฑุญูุฉ: ${gradeName}</p>
                  <a href="${quiz.googleFormUrl}" target="_blank" class="text-xs text-blue-400 hover:underline flex items-center">
                      <i class="fas fa-link ml-1"></i> ุฑุงุจุท ุงููููุฐุฌ
                  </a>
              </div>
              <button data-doc-id="${quiz.id}" data-type="quiz" class="py-1 px-3 rounded-md delete-btn text-white text-xs transition">ุญุฐู ุงูุงุฎุชุจุงุฑ</button>
          `;
        card.innerHTML = content;
        quizzesListEl.appendChild(card);

        card
          .querySelector(".delete-btn")
          ?.addEventListener("click", handleDelete);
      }

      // **************** ุฏุงูุฉ ุฅุถุงูุฉ ุงุฎุชุจุงุฑ ุฌุฏูุฏ (Google Form) ****************
      document
        .getElementById("add-quiz-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!isUserAdmin || !isAdminMode) {
            showMessage(
              quizStatusMessageEl,
              "ุบูุฑ ูุณููุญ. ูููู ูููุฏูุฑ ููุท ุงูุฅุถุงูุฉ.",
              true
            );
            return;
          }

          const gradeLevel = document.getElementById("quiz-grade-select").value;
          const title = document.getElementById("quiz-title").value;
          const googleFormUrl = document.getElementById(
            "quiz-google-form-url"
          ).value;
          const maxScore = parseInt(
            document.getElementById("quiz-max-score").value
          );
          const description = document.getElementById("quiz-description").value;
          
          if (!gradeLevel) {
               showMessage(quizStatusMessageEl, "ูุฌุจ ุชุญุฏูุฏ ุงููุฑุญูุฉ ุงูุชุนููููุฉ.", true);
               return;
          }


          if (!title || !googleFormUrl || isNaN(maxScore) || maxScore <= 0) {
            showMessage(
              quizStatusMessageEl,
              "ูุฌุจ ููุก ุญูู ุงูุนููุงู ูุฑุงุจุท Google Form ูุงูุฏุฑุฌุฉ ุงููููุฉ (ุฃูุจุฑ ูู ุตูุฑ).",
              true
            );
            return;
          }

          addQuizBtn.disabled = true;
          showMessage(
            quizStatusMessageEl,
            "ุฌุงุฑู ูุดุฑ ุงูุงุฎุชุจุงุฑ (Google Form)...",
            false
          );

          try {
            const quizzesRef = collection(
              db,
              "artifacts",
              appId,
              "public",
              "data",
              "quizzes"
            );

            await addDoc(quizzesRef, {
              gradeLevel: gradeLevel, // ุฅุถุงูุฉ ุงููุฑุญูุฉ ุงูุชุนููููุฉ
              title: title,
              maxScore: maxScore,
              googleFormUrl: googleFormUrl,
              description: description,
              authorId: userId,
              createdAt: new Date().toISOString(),
            });

            showMessage(
              quizStatusMessageEl,
              `โ ุชู ุฅุถุงูุฉ ุงูุงุฎุชุจุงุฑ ุจูุฌุงุญ! ูููู ููุทูุงุจ ุงููุตูู ุฅููู ุงูุขู.`,
              false
            );
            document.getElementById("add-quiz-form").reset();
          } catch (e) {
            console.error("Error adding quiz: ", e);
            showMessage(
              quizStatusMessageEl,
              `โ ุฎุทุฃ ูู ูุดุฑ ุงูุงุฎุชุจุงุฑ: ${e.message}. ูุฑุฌู ูุฑุงุฌุนุฉ ููุงุนุฏ ุฃูุงู Firestore.`,
              true
            );
          } finally {
            addQuizBtn.disabled = false;
          }
        });

      // **************** ูุธููุฉ ุฑุตุฏ ุงูุฏุฑุฌุงุช (ุฌุฏูุฏ) ****************

      const scoreStatusMessageEl = document.getElementById("score-status-message");
      const scoreStudentSelect = document.getElementById("score-student-select");
      const scoreQuizSelect = document.getElementById("score-quiz-select");
      const scoreMaxDisplay = document.getElementById("score-max-display");

      // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช ูู ูููุฐุฌ ุฑุตุฏ ุงูุฏุฑุฌุงุช
      function updateQuizSelectOptions() {
          scoreQuizSelect.innerHTML = '<option value="">-- ุญุฏุฏ ุงูุงุฎุชุจุงุฑ --</option>';
          allQuizzes.forEach(quiz => {
              const option = document.createElement('option');
              option.value = quiz.id;
              
              // ุนุฑุถ ุงุณู ุงููุฑุญูุฉ ุงูุชุนููููุฉ ูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ ูููุฏูุฑ
              const gradeName = availableGrades.find(g => g.id === quiz.gradeLevel)?.name || 'ุบูุฑ ูุญุฏุฏ';
              
              option.textContent = `${quiz.title} (${gradeName} | ุงููููุฉ: ${quiz.maxScore})`;
              option.dataset.maxScore = quiz.maxScore;
              scoreQuizSelect.appendChild(option);
          });
      }

      // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุทูุงุจ ุงููุนุชูุฏูู ููููุฐุฌ ุฑุตุฏ ุงูุฏุฑุฌุงุช
      function loadStudentsForScoreEntry() {
          if (!db || !isAuthReady || !isUserAdmin) return;
          
          const profilesRef = collection(db, "artifacts", appId, "user_profiles");
          // ูุญุชุงุฌ ููุท ุงูุทูุงุจ ุงููุนุชูุฏูู
          const studentsQuery = query(profilesRef, where('isApproved', '==', true), where('role', '==', 'student'));

          onSnapshot(studentsQuery, (snapshot) => {
              scoreStudentSelect.innerHTML = '<option value="">-- ุญุฏุฏ ุงูุทุงูุจ --</option>';
              studentsProfiles = []; 
              
              snapshot.forEach((doc) => {
                  const profile = doc.data();
                  studentsProfiles.push(profile);
                  
                  // ุนุฑุถ ุงุณู ุงููุฑุญูุฉ ููุทุงูุจ
                  const gradeName = availableGrades.find(g => g.id === profile.gradeLevel)?.name || 'ูู ูุฎุชุฑ ูุฑุญูุฉ';

                  const option = document.createElement('option');
                  option.value = profile.uid;
                  option.textContent = `${profile.name} (${profile.email} | ${gradeName})`;
                  scoreStudentSelect.appendChild(option);
              });
          }, (error) => {
              console.error("Error loading students for scoring:", error);
          });
          
          // ุชุฃูุฏ ูู ุชุญููู ูุงุฆูุฉ ุงูุงุฎุชุจุงุฑุงุช ุฃูุถุงู
          loadQuizzesAndResults();
      }
      
      // ุชุญุฏูุซ ุงูุฏุฑุฌุฉ ุงููููุฉ ุนูุฏ ุงุฎุชูุงุฑ ุงูุงุฎุชุจุงุฑ
      scoreQuizSelect.addEventListener('change', () => {
          const selectedOption = scoreQuizSelect.options[scoreQuizSelect.selectedIndex];
          if (selectedOption && selectedOption.dataset.maxScore) {
              scoreMaxDisplay.value = selectedOption.dataset.maxScore;
          } else {
              scoreMaxDisplay.value = '';
          }
      });
      
      // ูุนุงูุฌุฉ ุฅุฑุณุงู ุฑุตุฏ ุงูุฏุฑุฌุงุช
      document.getElementById('score-entry-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!isUserAdmin || !isAdminMode) {
              showMessage(scoreStatusMessageEl, "ุบูุฑ ูุณููุญ. ูููู ูููุฏูุฑ ููุท ุฑุตุฏ ุงูุฏุฑุฌุงุช.", true);
              return;
          }
          
          const studentId = scoreStudentSelect.value;
          const quizId = scoreQuizSelect.value;
          const score = parseInt(document.getElementById('score-value').value);
          const notes = document.getElementById('score-notes').value;
          const maxScore = parseInt(scoreMaxDisplay.value);

          if (!studentId || !quizId || isNaN(score) || score < 0 || score > maxScore) {
              showMessage(scoreStatusMessageEl, "ูุฑุฌู ุงุฎุชูุงุฑ ุทุงูุจ ูุงุฎุชุจุงุฑ ูุฅุฏุฎุงู ุฏุฑุฌุฉ ุตุญูุญุฉ ูุง ุชุชุฌุงูุฒ ุงูุฏุฑุฌุฉ ุงููููุฉ.", true);
              return;
          }
          
          document.getElementById('submit-score-btn').disabled = true;
          showMessage(scoreStatusMessageEl, "ุฌุงุฑู ุชุณุฌูู ุงูุฏุฑุฌุฉ...", false);

          try {
              // ูุณุงุฑ ุญูุธ ูุชูุฌุฉ ุงูุทุงูุจ
              const resultDocRef = doc(db, "artifacts", appId, "users", studentId, "quiz_results", quizId);
              
              await setDoc(resultDocRef, {
                  quizId: quizId,
                  score: score,
                  maxScore: maxScore,
                  notes: notes,
                  recordedBy: userId,
                  recordedAt: new Date().toISOString()
              });
              
              showMessage(scoreStatusMessageEl, `โ ุชู ุชุณุฌูู ุงูุฏุฑุฌุฉ (${score}/${maxScore}) ููุทุงูุจ ุจูุฌุงุญ!`, false);
              document.getElementById('score-entry-form').reset();

          } catch (e) {
              console.error("Error recording score: ", e);
              showMessage(scoreStatusMessageEl, `โ ุฎุทุฃ ูู ุชุณุฌูู ุงูุฏุฑุฌุฉ: ${e.message}. ูุฑุฌู ูุฑุงุฌุนุฉ ููุงุนุฏ ุฃูุงู Firestore.`, true);
          } finally {
              document.getElementById('submit-score-btn').disabled = false;
          }
      });
      

      // **************** ุฏุงูุฉ ุชุญููู ุฌููุน ุงููุณุชุฎุฏููู (ูููุฏูุฑ) ****************
      function loadAllUsers() {
        if (unsubscribeUsers) {
          unsubscribeUsers();
          unsubscribeUsers = null;
        }

        if (!db || !isAuthReady || !isUserAdmin || !isAdminMode) return;

        const profilesRef = collection(db, "artifacts", appId, "user_profiles");
        const usersQuery = query(profilesRef, limit(50));
        const userSearchInput = document.getElementById("user-search-input");
        const searchTerm = userSearchInput?.value?.trim().toLowerCase();

        pendingUsersList.innerHTML = `<p class="text-gray-500" id="users-loading-status">ุฌุงุฑู ุชุญููู ูุงุฆูุฉ ุงููุณุชุฎุฏููู...</p>`;

        unsubscribeUsers = onSnapshot(
          usersQuery,
          (snapshot) => {
            pendingUsersList.innerHTML = "";
            let users = [];

            snapshot.forEach((doc) => {
              const profile = doc.data();

              if (
                profile.uid !== userId &&
                (!searchTerm ||
                  profile.name?.toLowerCase().includes(searchTerm) ||
                  profile.email?.toLowerCase().includes(searchTerm))
              ) {
                users.push(profile);
              }
            });

            if (users.length === 0) {
              pendingUsersList.innerHTML = `<p class="text-gray-500">ูุง ููุฌุฏ ูุณุชุฎุฏููู ูุทุงุจููู ุฃู ูุนูููู ุญุงููุงู.</p>`;
              return;
            }

            users.forEach((profile) => {
              const userCard = document.createElement("div");
              userCard.className =
                "flex flex-col md:flex-row justify-between items-center p-4 bg-gray-800 rounded-lg gold-border border";

              let statusBadge = profile.isApproved
                ? profile.role === "admin"
                  ? `<span class="text-green-400">ูุฏูุฑ</span>`
                  : `<span class="text-yellow-400">ูููุงููู ุนููู</span>`
                : `<span class="text-red-400">ููุนููููู</span>`;
              
              const gradeName = availableGrades.find(g => g.id === profile.gradeLevel)?.name || 'ุบูุฑ ูุญุฏุฏ';


              let actionButtons = "";
              const uid = profile.uid;

              if (profile.role === "student" && !profile.isApproved) {
                actionButtons = `
                          <button data-uid="${uid}" data-action="approve" class="py-1 px-3 rounded-md bg-green-700 text-white text-sm hover:bg-green-600 transition">ููุงููุฉ (ุทุงูุจ)</button>
                          <button data-uid="${uid}" data-action="set-admin" class="py-1 px-3 rounded-md admin-set-btn text-white text-sm hover:bg-yellow-700 transition">ุชุนููู ููุฏูุฑ</button>
                          <button data-uid="${uid}" data-action="reject" class="py-1 px-3 rounded-md delete-btn text-white text-sm hover:bg-red-700 transition">ุฑูุถ/ุญุฐู</button>
                      `;
              } else if (profile.role === "student" && profile.isApproved) {
                actionButtons = `
                          <button data-uid="${uid}" data-action="set-admin" class="py-1 px-3 rounded-md admin-set-btn text-white text-sm hover:bg-yellow-700 transition">ุชุนููู ููุฏูุฑ</button>
                          <button data-uid="${uid}" data-action="reject" class="py-1 px-3 rounded-md delete-btn text-white text-sm hover:bg-red-700 transition">ุญุฐู</button>
                      `;
              } else if (profile.role === "admin") {
                actionButtons = `<button data-uid="${uid}" data-action="demote" class="py-1 px-3 rounded-md bg-gray-600 text-white text-sm hover:bg-gray-500 transition">ุฅูุบุงุก ุฏูุฑ ุงููุฏูุฑ</button>`;
              }

              userCard.innerHTML = `
                      <div class="mb-2 md:mb-0 text-center md:text-right">
                          <p class="font-bold gold-color">${
                            profile.name
                          } (${statusBadge})</p>
                          <p class="text-sm text-gray-400">ุงูุจุฑูุฏ: ${
                            profile.email
                          }</p>
                          <p class="text-xs text-gray-500">ุงููุฑุญูุฉ: ${gradeName} | ID: ${uid.substring(
                            0,
                            8
                          )}... | ูุณุฌู ูู: ${new Date(
                profile.createdAt
              ).toLocaleDateString("ar-EG")}</p>
                      </div>
                      <div class="space-x-2 space-x-reverse flex justify-center w-full md:w-auto mt-2 md:mt-0">
                          ${actionButtons}
                      </div>
                  `;
              pendingUsersList.appendChild(userCard);
            });

            pendingUsersList.querySelectorAll("button").forEach((btn) => {
              btn.addEventListener("click", handleUserAction);
            });
          },
          (error) => {
            console.error("Error listening to users:", error);
            pendingUsersList.innerHTML = `<p class="text-red-500">ุฎุทุฃ ูู ุชุญููู ุงููุณุชุฎุฏููู: ${error.message}. ูุฑุฌู ูุฑุงุฌุนุฉ ููุงุนุฏ ุฃูุงู Firestore.</p>`;
          }
        );
      }

      // **************** ูุนุงูุฌุฉ ุฅุฌุฑุงุกุงุช ุงููุฏูุฑ ุนูู ุงููุณุชุฎุฏู ****************
      async function handleUserAction(e) {
        const docId = e.currentTarget.dataset.uid;
        const action = e.currentTarget.dataset.action;
        const userDocRef = doc(db, "artifacts", appId, "user_profiles", docId);

        if (!db || !isUserAdmin || !isAdminMode) {
          showMessage(
            currentUserInfoEl,
            "ุบูุฑ ูุณููุญ ูู ุจุฅุฌุฑุงุก ูุฐุง ุงูุฅุฌุฑุงุก.",
            true
          );
          return;
        }

        showMessage(
          currentUserInfoEl,
          `ุฌุงุฑู ุชูููุฐ ุงูุฅุฌุฑุงุก (${action}) ุนูู ุงููุณุชุฎุฏู...`,
          false
        );

        try {
          if (action === "approve") {
            await updateDoc(userDocRef, { isApproved: true, role: "student" });
          } else if (action === "set-admin") {
            await updateDoc(userDocRef, { isApproved: true, role: "admin" });
          } else if (action === "demote") {
            await updateDoc(userDocRef, { role: "student" });
          } else if (action === "reject") {
            await deleteDoc(userDocRef);
          }
          showMessage(
            currentUserInfoEl,
            `โ ุชู ุชูููุฐ ุงูุฅุฌุฑุงุก ุจูุฌุงุญ: ${action}`,
            false
          );
        } catch (error) {
          console.error(`Error performing action (${action}):`, error);
          showMessage(
            currentUserInfoEl,
            `โ ูุดู ุงูุชูููุฐ: ${error.message}`,
            true
          );
        }
      }

      // **************** ุฏุงูุฉ ุญุฐู ุงููุญุชูู (ุฏุฑูุณ/ุดุฎุตูุงุช/ุงุฎุชุจุงุฑุงุช) ****************
      async function handleDelete(e) {
        const docId = e.currentTarget.dataset.docId;
        const docType = e.currentTarget.dataset.type;

        if (!isUserAdmin || !isAdminMode) {
          return;
        }

        let collectionPath;

        switch (docType) {
          case "lesson":
            collectionPath = "history_lessons";
            break;
          case "character":
            collectionPath = "historical_characters";
            break;
          case "quiz":
            collectionPath = "quizzes";
            break;
          case "grade": // ูุนุงูุฌุฉ ุญุฐู ุงููุฑุญูุฉ ุงูุชุนููููุฉ ุงูุฌุฏูุฏุฉ
            collectionPath = "grade_levels";
            break;
          default:
            return;
        }

        try {
            const docRef = doc(
                db,
                "artifacts",
                appId,
                docType === 'grade' ? "public/data/grade_levels" : "public/data",
                collectionPath,
                docId
            );
          await deleteDoc(docRef);
        } catch (e) {
          console.error(`Error removing ${docType} document: `, e);
          showMessage(currentUserInfoEl, `ุฎุทุฃ ูู ุงูุญุฐู: ${e.message}`, true);
        }
      }

      // **************** ุฅุถุงูุฉ ุฏุงูุฉ ูุฒุฑ ุงูุจุญุซ ****************
      userSearchInput?.addEventListener("input", () => {
        loadAllUsers();
      });
    </script>
  </body>
</html>
